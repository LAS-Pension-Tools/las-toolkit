<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NHS Pension Opt-Out Calculator (England only)</title>
<link rel="icon" href="../favicon.ico">
<style>
/* Accessible, high-contrast, no external CSS */
:root{
  --brand:#023020; --text:#111; --muted:#4A5568;
  --bg:#FAFAFA; --panel:#FFF; --border:#D6D9DC; --focus:#0B69A3;
}
@media (prefers-color-scheme: dark){
  :root{ --bg:#0f1214; --panel:#121618; --text:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; }
}
*{ box-sizing:border-box }
body{ margin:0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }
.wrap{ max-width: 1000px; margin: 0 auto; padding: 20px; }
h1{ margin:0 0 4px 0; font-size:22px }
h2{ margin:0 0 10px 0; font-size:18px; color:var(--brand) }
.panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; }
.grid{ display:grid; gap:14px }
@media (min-width:860px){ .cols-2{ grid-template-columns: 1fr 1fr } }
label{ font-size:14px; display:block }
input,select,textarea{ width:100%; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--text); padding:8px 10px }
:focus-visible{ outline:3px solid var(--focus); outline-offset:2px; border-radius:6px }
.btn{ appearance:none; border:2px solid var(--brand); color:var(--brand); background:transparent; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer }
.btn:hover{ background:#F0F7F4 }
.btn.primary{ background:var(--brand); color:#fff }
.btn.primary:hover{ filter:brightness(.95) }
.row{ display:grid; grid-template-columns: repeat(12,1fr); gap:8px; align-items:end }
.small{ font-size:12px; opacity:.8 }
.muted{ color:var(--muted) }
.table{ width:100%; border-collapse:collapse }
th,td{ padding:10px; border-bottom:1px solid var(--border); text-align:left }
.right{ text-align:right }
.pill{ display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px }
.kpi{ border:1px solid var(--border); border-radius:12px; padding:12px }
.flex{ display:flex; gap:8px; align-items:center }
.space{ display:flex; justify-content:space-between; align-items:center }
.hidden{ display:none !important }
</style>
</head>
<body>
<div class="wrap">
  <header class="panel flex" style="justify-content:space-between">
    <div>
      <h1>NHS Pension Opt-Out Calculator</h1>
      <div class="small muted">England & NI — monthly payslip illustration (stay in vs opt out). NI inferred from your DOB.</div>
    </div>
    <div class="flex">
      <button id="adminToggle" class="btn" type="button">Admin</button>
    </div>
  </header>

  <section class="grid cols-2" style="margin-top:16px">
    <div class="panel">
      <h2>Pensionable pay (monthly)</h2>
      <div id="items"></div>
      <div class="space" style="margin-top:10px; border-top:1px solid var(--border); padding-top:10px">
        <div class="muted">Total monthly pensionable pay</div>
        <div id="grossOut"><b>£0.00</b></div>
      </div>
      <div class="flex" style="margin-top:8px">
        <button id="addItem" class="btn" type="button">+ Add item</button>
        <button id="clearItems" class="btn" type="button">Clear</button>
      </div>
    </div>

    <div class="panel">
      <h2>Your details</h2>
      <div class="grid">
        <label>Date of birth
          <input id="dob" type="date" placeholder="YYYY-MM-DD">
        </label>
        <label>Tax code (optional)
          <input id="taxCode" placeholder="1257L, BR, D0, D1, NT" value="1257L">
        </label>
      </div>
      <div class="small muted" style="margin-top:8px">
        If your age at the end of this month is <b>66+</b>, employee NI is <b>£0</b> (Category C).
        If you’re <b>&lt;21</b>, NI category is <b>M</b> (same employee rates as A; employer relief not shown).
      </div>
    </div>
  </section>

  <section class="panel" style="margin-top:16px">
    <div class="space">
      <h2>Payslip illustration (monthly)</h2>
      <button id="helpToggle" type="button" class="btn">How this is worked out</button>
    </div>
    <div id="help" class="hidden" style="margin:10px 0">
      <ul class="small muted">
        <li>Income Tax: rUK (England & NI) bands monthly-ised with personal allowance; taper above £100k adjusted net income.</li>
        <li>National Insurance: A/M 8% between PT £1,048 and UEL £4,189, 2% above; C (66+) £0 employee NI.</li>
        <li>NHS pension (employee): tier picked from <em>annual</em> pensionable pay; applied monthly.</li>
      </ul>
    </div>
    <div style="overflow-x:auto">
      <table class="table">
        <thead>
          <tr><th>Item</th><th class="right">Stay in</th><th class="right">Opt out</th></tr>
        </thead>
        <tbody>
          <tr><td>Gross pay (monthly)</td><td class="right" id="grossStay">£0.00</td><td class="right" id="grossOut2">£0.00</td></tr>
          <tr><td>NHS pension (employee) <span id="nhsPct" class="pill hidden"></span></td><td class="right" id="nhsStay">£0.00</td><td class="right">£0.00</td></tr>
          <tr><td>Taxable pay this month</td><td class="right" id="taxableStay">£0.00</td><td class="right" id="taxableOut">£0.00</td></tr>
          <tr><td>Income Tax (PAYE)</td><td class="right" id="taxStay">£0.00</td><td class="right" id="taxOut">£0.00</td></tr>
          <tr><td>National Insurance (employee) <span class="muted small">(NI cat: <span id="niCat">A</span>)</span></td><td class="right" id="niStay">£0.00</td><td class="right" id="niOut">£0.00</td></tr>
          <tr style="font-weight:700; border-top:1px solid var(--border)"><td>Net take-home pay</td><td class="right" id="netStay">£0.00</td><td class="right" id="netOut">£0.00</td></tr>
        </tbody>
      </table>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="kpi">
        <div class="muted small">Difference in take-home (opt-out minus stay-in)</div>
        <div id="delta" style="font-weight:800; font-size:20px">£0.00</div>
      </div>
    </div>

    <details style="margin-top:10px">
      <summary class="small">Additional information</summary>
      <div class="grid" style="margin-top:8px">
        <div class="kpi">
          <div class="muted small">Annual pensionable pay</div>
          <div id="annualOut" style="font-weight:800; font-size:18px">£0.00</div>
        </div>
        <div class="kpi">
          <div class="muted small">Employer pension (context)</div>
          <div id="erOut" style="font-weight:800; font-size:18px">£0.00/yr</div>
          <div class="small muted">Not deducted from pay but foregone if you opt out.</div>
        </div>
      </div>
    </details>
  </section>

  <section id="admin" class="panel hidden" style="margin-top:16px">
    <h2>Admin — Rates (paste/edit yearly)</h2>
    <p class="small muted">Changes save to this browser (localStorage). You can Export to a JSON file and commit it to your repo later.</p>
    <div class="grid cols-2">
      <label>Current JSON
        <textarea id="currentJson" rows="16" readonly></textarea>
      </label>
      <div>
        <label>Paste new JSON
          <textarea id="pasteJson" rows="16" placeholder='{"years":[ ... ]}'></textarea>
        </label>
        <div class="flex" style="margin-top:8px">
          <button id="importBtn" class="btn" type="button">Import</button>
          <button id="exportBtn" class="btn" type="button">Export</button>
          <button id="resetBtn" class="btn" type="button">Reset to defaults</button>
        </div>
      </div>
    </div>
  </section>

  <footer class="small muted" style="margin:14px 0">
    HMRC PAYE & NI 2025/26; NHSBSA member tiers 2025/26. For guidance only.
  </footer>
</div>

<script>
/*** ===== Data & Utils ===== ***/
const defaultRates = {
  defaultYear: "2025/26",
  years: [{
    label: "2025/26",
    tax: {
      personalAllowance: 12570,
      higherRateThreshold: 37700,
      additionalRateThreshold: 125140,
      bands: {
        ENG_NI: [
          { upper: 37700, rate: 0.20 },
          { upper: 125140, rate: 0.40 },
          { upper: null,   rate: 0.45 }
        ]
      }
    },
    ni: {
      monthly: { LEL: 542, PT: 1048, UEL: 4189 },
      employeeRates: { main: 0.08, upper: 0.02 }
    },
    nhs: {
      tiers: [
        { min:     0, max: 13259, rate: 0.052 },
        { min: 13260, max: 27797, rate: 0.065 },
        { min: 27798, max: 33868, rate: 0.083 },
        { min: 33869, max: 50845, rate: 0.098 },
        { min: 50846, max: 65190, rate: 0.107 },
        { min: 65191, max: null,  rate: 0.125 }
      ],
      employerRateHint: 0.237
    }
  }]
};

const fmt = n => (n||0).toLocaleString("en-GB",{style:"currency",currency:"GBP"});
const pct = n => (n*100).toFixed(1)+"%";
function loadRates(){
  try{ const raw = localStorage.getItem("las_optout_rates_v1");
       if(!raw) return defaultRates;
       const parsed = JSON.parse(raw); return parsed?.years?.length ? parsed : defaultRates;
  }catch{ return defaultRates }
}
function saveRates(r){ localStorage.setItem("las_optout_rates_v1", JSON.stringify(r,null,2)); }
function lastDayOfThisMonth(ref=new Date()){ return new Date(ref.getFullYear(), ref.getMonth()+1, 0); }
function ageOnDate(dob, on){
  if(!dob) return null; const d=new Date(dob); if(isNaN(d)) return null;
  let a=on.getFullYear()-d.getFullYear(); const m=on.getMonth()-d.getMonth();
  if(m<0 || (m===0 && on.getDate()<d.getDate())) a--; return a;
}
function inferNICat(dob){
  const a=ageOnDate(dob, lastDayOfThisMonth());
  if(a==null) return "A";
  if(a>=66) return "C";
  if(a<21) return "M";
  return "A";
}
function parseTaxCode(code){
  const c=(code||"").toUpperCase().trim();
  if(!c) return { mode:"STANDARD", allowance:12570 };
  if(["BR","D0","D1","NT"].includes(c)) return { mode:c };
  const m=c.match(/(\d{3,4})[A-Z]*/); if(m) return { mode:"STANDARD", allowance: parseInt(m[1],10)*10 };
  return { mode:"STANDARD", allowance:12570 };
}
function nhsMemberRate(annual, nhs){
  const t = nhs.tiers.find(t=> annual>=t.min && (t.max==null || annual<=t.max));
  return t ? t.rate : 0;
}
function calcPAYE(monthlyTaxable, annualANI, taxCfg, codeParsed){
  const taperStart=100000;
  const pa0 = codeParsed.mode==="STANDARD" ? taxCfg.personalAllowance : 0;
  const pa  = codeParsed.mode==="STANDARD" ? Math.max(0, pa0 - Math.max(0, Math.floor((annualANI - taperStart)/2))) : 0;

  if(codeParsed.mode==="NT") return 0;
  if(codeParsed.mode==="BR") return monthlyTaxable * 0.20;
  if(codeParsed.mode==="D0") return monthlyTaxable * 0.40;
  if(codeParsed.mode==="D1") return monthlyTaxable * 0.45;

  const monthlyPA = pa/12;
  let remaining = Math.max(0, monthlyTaxable - monthlyPA);
  const bands = taxCfg.bands.ENG_NI;
  let tax=0, lower=0;
  for(const b of bands){
    const upper = b.upper ?? Infinity;
    const bandMonthly = (upper - lower)/12;
    const take = Math.max(0, Math.min(remaining, bandMonthly));
    tax += take * b.rate;
    remaining -= take;
    lower = upper;
    if(remaining<=0) break;
  }
  if(remaining>0) tax += remaining * (bands[bands.length-1].rate);
  return tax;
}
function calcNI(monthlyGross, niCfg, niCat){
  if(niCat==="C") return 0;
  const { PT, UEL } = niCfg.monthly;
  if(monthlyGross<=PT) return 0;
  const between = Math.max(0, Math.min(monthlyGross, UEL) - PT);
  const above = Math.max(0, monthlyGross - UEL);
  return between*niCfg.employeeRates.main + above*niCfg.employeeRates.upper;
}
function safeId(){
  const r=()=>Math.floor((1+Math.random())*0x10000).toString(16).slice(1);
  return `id-${Date.now().toString(16)}-${r()}${r()}-${r()}`;
}

/*** ===== State ===== ***/
let RATES = loadRates();
let state = {
  items: [
    { id:safeId(), label:"Basic", amount:0, useRate:false },
    { id:safeId(), label:"HCA",   amount:0, useRate:false }
  ],
  dob: "",
  taxCode: "1257L"
};

/*** ===== DOM refs ===== ***/
const elItems = document.getElementById("items");
const elAdd   = document.getElementById("addItem");
const elClear = document.getElementById("clearItems");
const elDob   = document.getElementById("dob");
const elTax   = document.getElementById("taxCode");
const elAdmin = document.getElementById("admin");
const elAdminToggle = document.getElementById("adminToggle");
const elHelpToggle = document.getElementById("helpToggle");
const elHelp = document.getElementById("help");

// Outputs
const out = {
  gross: document.getElementById("grossOut"),
  grossStay: document.getElementById("grossStay"),
  grossOut2: document.getElementById("grossOut2"),
  nhsPct: document.getElementById("nhsPct"),
  nhsStay: document.getElementById("nhsStay"),
  taxableStay: document.getElementById("taxableStay"),
  taxableOut: document.getElementById("taxableOut"),
  taxStay: document.getElementById("taxStay"),
  taxOut: document.getElementById("taxOut"),
  niStay: document.getElementById("niStay"),
  niOut: document.getElementById("niOut"),
  niCat: document.getElementById("niCat"),
  netStay: document.getElementById("netStay"),
  netOut: document.getElementById("netOut"),
  delta: document.getElementById("delta"),
  annual: document.getElementById("annualOut"),
  er: document.getElementById("erOut"),
  currentJson: document.getElementById("currentJson"),
  pasteJson: document.getElementById("pasteJson")
};

/*** ===== UI builders ===== ***/
function renderItems(){
  elItems.innerHTML = "";
  state.items.forEach(it=>{
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <input class="col-span-4" value="${it.label.replace(/"/g,"&quot;")}" data-id="${it.id}" data-k="label">
      <div class="col-span-3 flex">
        <input type="checkbox" ${it.useRate?"checked":""} data-id="${it.id}" data-k="useRate">
        <span class="small muted">rate × hours</span>
      </div>
      ${it.useRate ? `
        <input type="number" class="col-span-2" placeholder="rate" value="${it.rate??""}" data-id="${it.id}" data-k="rate">
        <input type="number" class="col-span-2" placeholder="hours" value="${it.hours??""}" data-id="${it.id}" data-k="hours">
        <div class="col-span-1 right small muted" data-id="${it.id}" data-k="calcCell"></div>
      ` : `
        <input type="number" class="col-span-6" value="${it.amount}" data-id="${it.id}" data-k="amount">
        <div class="col-span-1"></div>
      `}
      <button class="col-span-1 btn" data-id="${it.id}" data-k="remove">Remove</button>
    `;
    elItems.appendChild(row);
  });

  // wire events
  elItems.querySelectorAll("input,button").forEach(el=>{
    el.addEventListener("input", onItemChange);
    el.addEventListener("click", onItemChange);
  });

  updateCalcCells();
}
function onItemChange(e){
  const id = e.target.getAttribute("data-id");
  const k  = e.target.getAttribute("data-k");
  if(!id || !k) return;

  const idx = state.items.findIndex(x=>x.id===id);
  if(idx<0) return;

  if(k==="remove"){
    state.items.splice(idx,1);
  }else if(k==="useRate"){
    state.items[idx].useRate = e.target.checked;
  }else if(k==="label"){
    state.items[idx].label = e.target.value;
  }else if(k==="rate"){
    state.items[idx].rate = parseFloat(e.target.value || "0");
  }else if(k==="hours"){
    state.items[idx].hours = parseFloat(e.target.value || "0");
  }else if(k==="amount"){
    state.items[idx].amount = parseFloat(e.target.value || "0");
  }
  renderItems();
  recalc();
}
function updateCalcCells(){
  elItems.querySelectorAll('[data-k="calcCell"]').forEach(cell=>{
    const id = cell.getAttribute("data-id");
    const it = state.items.find(x=>x.id===id);
    if(!it) return;
    const val = (it.rate||0)*(it.hours||0);
    cell.textContent = fmt(val);
  });
}

/*** ===== Calculation ===== ***/
function recalc(){
  const year = RATES.years[0]; // England & NI by default
  const monthlyGross = state.items.reduce((s,it)=> s + (it.useRate ? (it.rate||0)*(it.hours||0) : (it.amount||0)), 0);
  const annualGross  = monthlyGross*12;

  const nhsRate = nhsMemberRate(annualGross, year.nhs);
  const nhsEE   = annualGross*nhsRate/12;

  const niCategory = inferNICat(state.dob);
  const niStay = calcNI(monthlyGross, year.ni, niCategory);
  const niOut  = calcNI(monthlyGross, year.ni, niCategory);

  const annualANI           = Math.max(0, annualGross - (annualGross*nhsRate)); // net pay arrangement
  const monthlyTaxableStay  = Math.max(0, monthlyGross - nhsEE);

  const codeParsed = parseTaxCode(state.taxCode);
  const taxStay = calcPAYE(monthlyTaxableStay, annualANI, year.tax, codeParsed);
  const taxOut  = calcPAYE(monthlyGross,       annualGross, year.tax, codeParsed);

  const netStay = monthlyGross - nhsEE - taxStay - niStay;
  const netOut  = monthlyGross - taxOut  - niOut;
  const delta   = netOut - netStay;

  // outputs
  out.gross.textContent    = fmt(monthlyGross);
  out.grossStay.textContent= fmt(monthlyGross);
  out.grossOut2.textContent= fmt(monthlyGross);

  if(nhsRate){ out.nhsPct.classList.remove("hidden"); out.nhsPct.textContent = pct(nhsRate); }
  else       { out.nhsPct.classList.add("hidden"); out.nhsPct.textContent = ""; }

  out.nhsStay.textContent  = fmt(nhsEE);
  out.taxableStay.textContent = fmt(monthlyTaxableStay);
  out.taxableOut.textContent  = fmt(monthlyGross);
  out.taxStay.textContent  = fmt(taxStay);
  out.taxOut.textContent   = fmt(taxOut);
  out.niStay.textContent   = fmt(niStay);
  out.niOut.textContent    = fmt(niOut);
  out.niCat.textContent    = niCategory;
  out.netStay.textContent  = fmt(netStay);
  out.netOut.textContent   = fmt(netOut);
  out.delta.textContent    = fmt(delta);
  out.delta.style.color    = delta >= 0 ? "#1b8555" : "#9F3131";

  out.annual.textContent   = fmt(annualGross);
  out.er.textContent       = "≈ " + fmt(annualGross*(year.nhs.employerRateHint||0)) + "/yr";
}

/*** ===== Admin panel ===== ***/
function renderAdmin(){
  out.currentJson.value = JSON.stringify(RATES, null, 2);
}
document.getElementById("importBtn").addEventListener("click", ()=>{
  try{
    const parsed = JSON.parse(out.pasteJson.value);
    if(!parsed?.years?.length) throw new Error("Malformed JSON");
    RATES = parsed; saveRates(parsed); out.pasteJson.value = "";
    renderAdmin(); recalc(); alert("Rates imported.");
  }catch(e){ alert("Import failed: " + (e.message||e)); }
});
document.getElementById("exportBtn").addEventListener("click", ()=>{
  const blob = new Blob([JSON.stringify(RATES,null,2)],{type:"application/json"});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download=`las-optout-rates-${Date.now()}.json`; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById("resetBtn").addEventListener("click", ()=>{
  RATES = defaultRates; saveRates(RATES); renderAdmin(); recalc(); alert("Reset to defaults.");
});

/*** ===== Wire up ===== ***/
elAdd.addEventListener("click", ()=>{ state.items.push({id:safeId(), label:"Other", amount:0, useRate:false}); renderItems(); recalc(); });
elClear.addEventListener("click", ()=>{ state.items = []; renderItems(); recalc(); });
elDob.addEventListener("input", e=>{ state.dob = e.target.value; recalc(); });
elTax.addEventListener("input", e=>{ state.taxCode = e.target.value; recalc(); });

elAdminToggle.addEventListener("click", ()=>{
  elAdmin.classList.toggle("hidden");
  if(!elAdmin.classList.contains("hidden")) renderAdmin();
});
elHelpToggle.addEventListener("click", ()=> elHelp.classList.toggle("hidden"));

renderItems();
renderAdmin();
recalc();
</script>
</body>
</html>
