<!doctype html>
<html lang="en-GB">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NHS Pension Opt-Out Calculator (England only)</title>
<link rel="icon" href="../favicon.ico">
<style>
  :root{ --bg:#0f1214; --card:#121618; --fg:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; --accent:#0B3A2D; --accent2:#59c38d; --warn:#9F3131; }
  @media (prefers-color-scheme: light){
    :root{ --bg:#FAFAFA; --card:#FFFFFF; --fg:#111; --muted:#4A5568; --border:#D6D9DC; --accent:#023020; --accent2:#1b8555; }
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--fg); line-height:1.5; }
  .wrap{ max-width:1000px; margin:0 auto; padding:20px; }
  .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .row{ display:grid; grid-template-columns:1fr; gap:16px; }
  @media (min-width:860px){ .row{ grid-template-columns:1fr 1fr; } }
  h1{ margin:0 0 4px 0; font-size:22px; }
  h2{ margin:0 0 10px 0; font-size:18px; }
  label{ font-size:14px; }
  input,select,textarea{ width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--fg); }
  input::placeholder{ color:var(--muted); }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:10px; border-bottom:1px solid var(--border); }
  th{ text-align:left; }
  .btn{ padding:8px 12px; border:2px solid var(--accent); background:transparent; color:var(--accent2); border-radius:10px; cursor:pointer; }
  .btn:hover{ background-color:#0b3a2d22; }
  .muted{ color:var(--muted); }
  .right{ text-align:right; }
  .grid12{ display:grid; grid-template-columns:repeat(12,1fr); gap:8px; align-items:end; }
  .pill{ display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; }
  .kpi{ border:1px solid var(--border); border-radius:12px; padding:12px; }
</style>
</head>
<body>
<div id="app"></div>

<!-- React (no build step) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
const { useState, useMemo, useEffect } = React;

/* ===== 2025/26 default rates (can be replaced via Admin) ===== */
const defaultRates = {
  defaultYear: "2025/26",
  years: [{
    label: "2025/26",
    tax: {
      personalAllowance: 12570,
      higherRateThreshold: 37700,
      additionalRateThreshold: 125140,
      bands: {
        ENG_NI: [
          { upper: 37700, rate: 0.20 },
          { upper: 125140, rate: 0.40 },
          { upper: null,   rate: 0.45 },
        ],
        WALES: [
          { upper: 37700, rate: 0.20 },
          { upper: 125140, rate: 0.40 },
          { upper: null,   rate: 0.45 },
        ],
        SCOT: [
          { upper:  2827,  rate: 0.19 },
          { upper: 14921,  rate: 0.20 },
          { upper: 31092,  rate: 0.21 },
          { upper: 62430,  rate: 0.42 },
          { upper: 125140, rate: 0.45 },
          { upper: null,   rate: 0.48 },
        ],
      }
    },
    ni: {
      monthly: { LEL: 542, PT: 1048, UEL: 4189 },
      employeeRates: { main: 0.08, upper: 0.02 }
    },
    nhs: {
      tiers: [
        { min:     0, max: 13259, rate: 0.052 },
        { min: 13260, max: 27797, rate: 0.065 },
        { min: 27798, max: 33868, rate: 0.083 },
        { min: 33869, max: 50845, rate: 0.098 },
        { min: 50846, max: 65190, rate: 0.107 },
        { min: 65191, max: null,  rate: 0.125 },
      ],
      employerRateHint: 0.237
    }
  }]
};

/* ===== Utils ===== */
const fmt = n => n.toLocaleString("en-GB", { style:"currency", currency:"GBP" });
const pct = n => (n*100).toFixed(1) + "%";
const getParam = k => new URL(location.href).searchParams.get(k);

function safeId(){
  try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
  const r=()=>Math.floor((1+Math.random())*0x10000).toString(16).slice(1);
  return `id-${Date.now().toString(16)}-${r()}${r()}-${r()}`;
}
function loadRates(){
  try{
    const raw = localStorage.getItem("las_optout_rates_v1");
    if(!raw) return defaultRates;
    const parsed = JSON.parse(raw);
    return parsed?.years?.length ? parsed : defaultRates;
  }catch{ return defaultRates; }
}
function saveRates(r){ localStorage.setItem("las_optout_rates_v1", JSON.stringify(r,null,2)); }

function parseTaxCode(code){
  const c=(code||"").toUpperCase().trim();
  if(!c) return { mode:"STANDARD", allowance:12570 };
  if(["BR","D0","D1","NT"].includes(c)) return { mode:c };
  const m=c.match(/(\d{3,4})[A-Z]*/);
  if(m) return { mode:"STANDARD", allowance: parseInt(m[1],10)*10 };
  return { mode:"STANDARD", allowance:12570 };
}

function lastDayOfThisMonth(ref=new Date()){
  const d = new Date(ref.getFullYear(), ref.getMonth()+1, 0); // day 0 of next month
  d.setHours(12,0,0,0);
  return d;
}
function ageOnDate(dob, on){
  if(!dob) return null;
  const birth = new Date(dob);
  if(isNaN(birth)) return null;
  let a = on.getFullYear()-birth.getFullYear();
  const m = on.getMonth()-birth.getMonth();
  if(m<0 || (m===0 && on.getDate()<birth.getDate())) a--;
  return a;
}

/** Infer NI category from age at month end (employee focus):
 *  - >=66 → C (no employee NI)
 *  - <21  → M (employee rates same as A)
 *  - else → A
 *  (Employer relief for M/H is not modelled.)
 */
function inferNICategory(age){
  if(age==null) return "A";
  if(age>=66) return "C";
  if(age<21)  return "M";
  return "A";
}

function nhsMemberRate(annual, nhs){
  const t = nhs.tiers.find(t => annual>=t.min && (t.max==null || annual<=t.max));
  return t? t.rate : 0;
}

/* Monthly PAYE (simple estimate with tapered PA above £100k) */
function calcPAYE(region, monthlyTaxable, annualANI, taxCfg, codeParsed){
  const taperStart=100000;
  const pa0 = codeParsed.mode==="STANDARD" ? taxCfg.personalAllowance : 0;
  const pa  = codeParsed.mode==="STANDARD" ? Math.max(0, pa0 - Math.max(0, Math.floor((annualANI - taperStart)/2))) : 0;

  if(codeParsed.mode==="NT") return 0;
  if(codeParsed.mode==="BR") return monthlyTaxable * 0.20;
  if(codeParsed.mode==="D0") return monthlyTaxable * 0.40;
  if(codeParsed.mode==="D1") return monthlyTaxable * 0.45;

  const monthlyPA = pa/12;
  let remaining = Math.max(0, monthlyTaxable - monthlyPA);
  const bands = taxCfg.bands[region];
  let tax=0, lower=0;
  for(const b of bands){
    const upper = b.upper ?? Infinity;
    const bandMonthly = (upper - lower)/12;
    const take = Math.max(0, Math.min(remaining, bandMonthly));
    tax += take * b.rate;
    remaining -= take;
    lower = upper;
    if(remaining<=0) break;
  }
  if(remaining>0) tax += remaining * (bands[bands.length-1].rate);
  return tax;
}

/* Employee NI — Category A/M same rates; C (over SPA) = 0 */
function calcNI(monthlyGross, niCfg, niCat){
  if(niCat==="C") return 0;
  const { PT, UEL } = niCfg.monthly;
  if(monthlyGross<=PT) return 0;
  const between = Math.max(0, Math.min(monthlyGross, UEL) - PT);
  const above   = Math.max(0, monthlyGross - UEL);
  return between*niCfg.employeeRates.main + above*niCfg.employeeRates.upper;
}

/* ===== App ===== */
function App(){
  const [region, setRegion] = useState("ENG_NI");
  const [dob, setDob] = useState("");
  const [taxCode, setTaxCode] = useState("1257L");
  const [items, setItems] = useState([
    { id:safeId(), label:"Basic", amount:0, useRate:false },
    { id:safeId(), label:"HCA",   amount:0, useRate:false },
  ]);
  const [rates, setRates] = useState(loadRates());
  const [year, setYear]   = useState(rates.defaultYear);
  const [openHelp, setOpenHelp] = useState(false);
  const [pasteJSON, setPasteJSON] = useState("");
  const showAdmin = getParam("admin")==="1";

  useEffect(()=>{ if(showAdmin) saveRates(rates); },[rates,showAdmin]);

  const activeYear = useMemo(()=> rates.years.find(y=>y.label===year)||rates.years[0],[rates,year]);

  const monthlyGross = useMemo(()=> items.reduce((s,it)=> s + (it.useRate? (Number(it.rate)||0)*(Number(it.hours)||0) : (Number(it.amount)||0)),0),[items]);
  const annualGross  = monthlyGross*12;

  // Age and NI category at end of CURRENT month (NHS payroll paid to month-end)
  const ageAtMonthEnd = useMemo(()=> ageOnDate(dob, lastDayOfThisMonth()), [dob]);
  const niCat = useMemo(()=> inferNICategory(ageAtMonthEnd), [ageAtMonthEnd]);

  // NHS member rate (annual)
  const nhsRate  = nhsMemberRate(annualGross, activeYear.nhs);
  const nhsEE    = annualGross*nhsRate/12;

  // PAYE bases
  const annualANI             = Math.max(0, annualGross - (annualGross*nhsRate)); // net pay arrangement
  const monthlyTaxableStayIn  = Math.max(0, monthlyGross - nhsEE);

  const codeParsed = useMemo(()=> parseTaxCode(taxCode), [taxCode]);

  // Taxes/NI
  const taxStay = calcPAYE(region, monthlyTaxableStayIn, annualANI, activeYear.tax, codeParsed);
  const taxOut  = calcPAYE(region, monthlyGross,          annualGross, activeYear.tax, codeParsed);
  const niStay  = calcNI(monthlyGross, activeYear.ni, niCat);
  const niOut   = calcNI(monthlyGross, activeYear.ni, niCat);

  // Nets
  const netStay = monthlyGross - nhsEE - taxStay - niStay;
  const netOut  = monthlyGross - taxOut  - niOut;
  const delta   = netOut - netStay;

  // handlers
  const addItem = ()=> setItems(p=>[...p,{ id:safeId(), label:"Other", amount:0 }]);
  const remove  = id => setItems(p=>p.filter(x=>x.id!==id));
  const update  = (id,patch)=> setItems(p=>p.map(x=> x.id===id ? {...x,...patch}: x));

  // admin
  function importRates(){
    try{
      const parsed = JSON.parse(pasteJSON);
      if(!parsed?.years?.length) throw new Error("Malformed JSON");
      setRates(parsed); saveRates(parsed); setPasteJSON(""); alert("Rates imported.");
    }catch(e){ alert("Import failed: " + (e?.message||e)); }
  }
  function exportRates(){
    const blob = new Blob([JSON.stringify(rates,null,2)],{type:"application/json"});
    const url  = URL.createObjectURL(blob);
    const a = document.createElement("a"); a.href=url; a.download=`las-optout-rates-${Date.now()}.json`; a.click();
    URL.revokeObjectURL(url);
  }

  return (
    <div className="wrap">
      <header className="card" style={{display:"flex",gap:"12px",alignItems:"center"}}>
        <div style={{flex:1}}>
          <h1>NHS Pension Opt-Out Calculator (England only)</h1>
          <div className="muted">Monthly payslip illustration — <b>stay in</b> vs <b>opt out</b>. Rates {activeYear.label}. NI is inferred from your date of birth.</div>
        </div>
        <div style={{display:"flex", gap:"8px", alignItems:"center"}}>
          <label className="muted">Year</label>
          <select value={year} onChange={e=>setYear(e.target.value)}>
            {rates.years.map(y=><option key={y.label} value={y.label}>{y.label}</option>)}
          </select>
          <label className="muted">Region</label>
          <select value={region} onChange={e=>setRegion(e.target.value)}>
            <option value="ENG_NI">England & NI</option>
            <option value="WALES">Wales</option>
            <option value="SCOT">Scotland</option>
          </select>
        </div>
      </header>

      <div className="row" style={{marginTop:"16px"}}>
        <section className="card">
          <h2>Pensionable pay (monthly)</h2>
          <div style={{display:"grid", gap:"10px"}}>
            {items.map(it=>(
              <div key={it.id} className="grid12">
                <input className="col-span-4" value={it.label} onChange={e=>update(it.id,{label:e.target.value})}/>
                <div className="col-span-3" style={{display:"flex",alignItems:"center",gap:"6px"}}>
                  <input type="checkbox" checked={!!it.useRate} onChange={e=>update(it.id,{useRate:e.target.checked})}/>
                  <span className="muted" style={{fontSize:"12px"}}>rate × hours</span>
                </div>
                {it.useRate ? (
                  <>
                    <input type="number" placeholder="rate" className="col-span-2" value={it.rate??""}
                           onChange={e=>update(it.id,{rate:parseFloat(e.target.value||"0")})}/>
                    <input type="number" placeholder="hours" className="col-span-2" value={it.hours??""}
                           onChange={e=>update(it.id,{hours:parseFloat(e.target.value||"0")})}/>
                    <div className="col-span-1 right muted">{fmt((it.rate||0)*(it.hours||0))}</div>
                  </>
                ) : (
                  <>
                    <input type="number" className="col-span-6" value={it.amount}
                           onChange={e=>update(it.id,{amount:parseFloat(e.target.value||"0")})}/>
                    <div className="col-span-1"></div>
                  </>
                )}
                <button className="btn" onClick={()=>remove(it.id)} title="Remove">Remove</button>
              </div>
            ))}
            <button className="btn" onClick={addItem}>+ Add item</button>
          </div>
          <div style={{display:"flex",justifyContent:"space-between",marginTop:"12px",paddingTop:"10px",borderTop:`1px solid var(--border)`}}>
            <div className="muted">Total monthly pensionable pay</div>
            <div><b>{fmt(monthlyGross)}</b></div>
          </div>
        </section>

        <section className="card">
          <h2>Your details</h2>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"10px"}}>
            <label className="muted" style={{gridColumn:"1 / span 2"}}>Date of birth
              <input type="date" value={dob} onChange={e=>setDob(e.target.value)} placeholder="YYYY-MM-DD"/>
            </label>
          </div>
          <div className="muted" style={{fontSize:"12px",marginTop:"8px"}}>
            We infer NI automatically. If your age at month-end is <b>66+</b>, employee NI is <b>£0</b> (Category C).
            If you’re <b>&lt;21</b>, you are Category <b>M</b> (same employee rates as A; employer relief not shown).
          </div>
          <div style={{display:"flex",justifyContent:"space-between",marginTop:"10px"}}>
            <div className="muted">Inferred NI category</div>
            <div className="pill">{niCat}</div>
          </div>
          <div style={{marginTop:"12px"}}>
            <label className="muted">Tax code (optional)
              <input value={taxCode} onChange={e=>setTaxCode(e.target.value)} placeholder="1257L, BR, D0, D1, NT"/>
            </label>
          </div>
        </section>
      </div>

      <section className="card" style={{marginTop:"16px"}}>
        <div style={{display:"flex",alignItems:"center",gap:"8px",marginBottom:"8px"}}>
          <h2 style={{margin:0}}>Payslip illustration (monthly)</h2>
          <button className="btn" style={{marginLeft:"auto"}} onClick={()=>setOpenHelp(s=>!s)}>
            {openHelp ? "Hide info" : "How this is worked out"}
          </button>
        </div>

        {openHelp && (
          <div className="card" style={{background:"transparent"}}>
            <ul className="muted">
              <li>Income Tax: region bands with monthly personal allowance (taper above £100k adjusted net income).</li>
              <li>National Insurance: A/M use 8% between PT £1,048 and UEL £4,189, 2% above; C (66+) is £0.</li>
              <li>NHS member contribution: based on <i>annual</i> pensionable pay; rate applied monthly.</li>
            </ul>
          </div>
        )}

        <div style={{overflowX:"auto", marginTop:"8px"}}>
          <table>
            <thead><tr><th>Item</th><th class="right">Stay in</th><th class="right">Opt out</th></tr></thead>
            <tbody>
              <tr><td>Gross pay (monthly)</td><td class="right">{fmt(monthlyGross)}</td><td class="right">{fmt(monthlyGross)}</td></tr>
              <tr><td>NHS pension (employee) {nhsRate? <span className="pill">{pct(nhsRate)}</span>: null}</td><td class="right">{fmt(nhsEE)}</td><td class="right">{fmt(0)}</td></tr>
              <tr><td>Taxable pay this month</td><td class="right">{fmt(Math.max(0, monthlyGross - nhsEE))}</td><td class="right">{fmt(monthlyGross)}</td></tr>
              <tr><td>Income Tax (PAYE)</td><td class="right">{fmt(taxStay)}</td><td class="right">{fmt(taxOut)}</td></tr>
              <tr><td>National Insurance (employee) <span className="muted">(NI cat: {niCat})</span></td><td class="right">{fmt(niStay)}</td><td class="right">{fmt(niOut)}</td></tr>
              <tr style={{fontWeight:700}}><td>Net take-home pay</td><td class="right">{fmt(netStay)}</td><td class="right">{fmt(netOut)}</td></tr>
            </tbody>
          </table>
        </div>

        <div className="row" style={{marginTop:"10px"}}>
          <div className="kpi"><div className="muted">Difference in take-home (opt-out minus stay-in)</div><div style={{fontWeight:800, fontSize:"20px", color: delta>=0? "#59c38d":"#ff7b7b"}}>{fmt(delta)}</div></div>
          <div className="kpi"><div className="muted">Annual pensionable pay</div><div style={{fontWeight:800, fontSize:"20px"}}>{fmt(annualGross)}</div></div>
          <div className="kpi"><div className="muted">Employer pension (context)</div><div style={{fontWeight:800, fontSize:"20px"}}>≈ {fmt(annualGross*(activeYear.nhs.employerRateHint||0))}/yr</div><div className="muted" style={{fontSize:"12px"}}>Not deducted from pay but foregone if you opt out.</div></div>
        </div>
      </section>

      {showAdmin && (
        <section className="card" style={{marginTop:"16px"}}>
          <h2>Admin — Rates (paste/edit yearly)</h2>
          <p className="muted" style={{margin:"6px 0"}}>Paste rates JSON; saved locally. Export to commit to your repo.</p>
          <div className="row">
            <div>
              <label className="muted">Current JSON
                <textarea rows="16" readOnly value={JSON.stringify(rates,null,2)}></textarea>
              </label>
              <div style={{marginTop:"8px"}}>
                <button className="btn" onClick={()=>{
                  const blob=new Blob([JSON.stringify(rates,null,2)],{type:"application/json"});
                  const url = URL.createObjectURL(blob); const a=document.createElement("a");
                  a.href=url; a.download=`las-optout-rates-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
                }}>Export</button>
              </div>
            </div>
            <div>
              <label className="muted">Paste new JSON
                <textarea rows="16" value={pasteJSON} onChange={e=>setPasteJSON(e.target.value)} placeholder='{ "years":[ ... ] }'></textarea>
              </label>
              <div style={{marginTop:"8px"}}>
                <button className="btn" onClick={()=>{
                  try{
                    const parsed=JSON.parse(pasteJSON);
                    if(!parsed?.years?.length) throw new Error("Malformed JSON");
                    setRates(parsed); saveRates(parsed); setPasteJSON(""); alert("Rates imported.");
                  }catch(e){ alert("Import failed: "+(e.message||e)); }
                }}>Import</button>
              </div>
            </div>
          </div>
        </section>
      )}

      <footer className="muted" style={{margin:"14px 0", fontSize:"12px"}}>
        Rates sources: HMRC PAYE & NI 2025/26; NHSBSA member tiers 2025/26. For guidance only.
      </footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
</script>
</body>
</html>
