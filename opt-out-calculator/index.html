<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NHS Pension Opt-Out Calculator (England only)</title>
  <meta name="description" content="NHS Pension Opt-Out Calculator (England only) — illustration of stay-in vs opt-out take-home.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23023020'/><text x='50' y='62' font-family='Arial' font-size='60' text-anchor='middle' fill='white'>£</text></svg>'">

<style>
  /* ---------- Design tokens ---------- */
  :root{
    --brand:#023020; --text:#111; --muted:#4A5568; --bg:#FAFAFA; --panel:#fff; --border:#D6D9DC; --focus:#0B69A3;
    --ok:#1b8555; --warn:#9F3131; --heading-w:800; --scale:1; --motion:1;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f1214; --panel:#121618; --text:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; }
  }
  html.theme-light{ --bg:#FAFAFA; --panel:#fff; --text:#111; --muted:#4A5568; --border:#D6D9DC; }
  html.theme-dark{  --bg:#0f1214; --panel:#121618; --text:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; }
  html.theme-hc{ --bg:#fff; --panel:#fff; --text:#000; --muted:#000; --border:#000; --focus:#003a7a; --heading-w:900; }
  html.theme-hc-large{ --bg:#fff; --panel:#fff; --text:#000; --muted:#000; --border:#000; --focus:#003a7a; --heading-w:900; --scale:1.12; }

  *{ box-sizing:border-box }
  html,body{ margin:0; padding:0 }
  body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; font-size:calc(16px * var(--scale)); }

  /* Skip link */
  a.skip{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
  a.skip:focus{ position:static; width:auto; height:auto; padding:8px 12px; background:#ffd; border:2px solid #000; border-radius:8px; display:inline-block; margin:8px; }

  .wrap{ max-width:980px; margin:0 auto; padding:20px; }

  /* Header + a11y bar */
  .header{ background:var(--brand); color:#fff; padding:16px; border-radius:12px; display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .header h1{ margin:0; font-size:22px; font-weight:var(--heading-w) }
  .a11y-bar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
  .a11y-group{ display:flex; gap:6px; align-items:center; background:rgba(255,255,255,.1); padding:6px; border-radius:10px }
  .a11y-label{ font-size:12px; color:#fff; opacity:.9 }
  .a11y-badge{ display:none; padding:4px 8px; border-radius:8px; background:#2e7d32; color:#fff; font-size:12px; font-weight:700 }

  /* Panels / layout */
  .panel{ background:var(--panel); border:2px solid var(--border); border-radius:12px; padding:16px; margin-top:16px }
  .grid2{ display:grid; grid-template-columns:1fr; gap:14px } @media(min-width:860px){ .grid2{ grid-template-columns:1fr 1fr } }
  .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:8px; align-items:end }
  .cs1{grid-column:span 1}.cs2{grid-column:span 2}.cs3{grid-column:span 3}.cs4{grid-column:span 4}.cs6{grid-column:span 6}
  label>span.small{ display:block; font-size:12px; margin-bottom:4px; color:var(--muted) }

  /* >>> Spacing between Basic, HCA, etc. */
  #items{ display:grid; row-gap:12px; }        /* change 12px to taste */

  /* Inputs/buttons */
  input,select,textarea{ width:100%; border:2px solid var(--border); background:var(--panel); color:var(--text); border-radius:8px; padding:9px 10px; font-weight:600 }
  input:focus,select:focus,textarea:focus,button:focus{ outline:4px solid var(--focus); outline-offset:2px }
  .btn{ appearance:none; background:var(--panel); color:var(--brand); border:3px solid var(--brand); padding:9px 12px; border-radius:10px; font-weight:800; cursor:pointer }
  .btn:hover{ background:#F0F7F4 }
  .btn.primary{ background:var(--brand); color:#fff }
  /* Small square “×” buttons */
  .btn.icon{ width:42px; height:42px; padding:0; display:inline-flex; align-items:center; justify-content:center; font-size:20px; line-height:1 }

  .small{ font-size:12px } .muted{ color:var(--muted) } .space{ display:flex; justify-content:space-between; align-items:center }
  .hide{ display:none } .text-green{ color:var(--ok) } .text-red{ color:var(--warn) }

  .payslip{ display:grid; grid-template-columns:1fr; gap:12px } @media(min-width:860px){ .payslip{ grid-template-columns:1fr 1fr } }
  .card{ border:2px solid var(--border); border-radius:12px; padding:12px }
  .tot{ border-top:2px solid var(--border); padding-top:8px; margin-top:8px; font-weight:800 }
  .kpi{ border:2px solid var(--border); border-radius:12px; padding:12px }
  .note{ border:3px solid var(--border); border-left:10px solid var(--brand); border-radius:10px; padding:10px 12px; background:var(--panel); color:var(--text) }

  /* Visually hidden */
  .sr-only{
    position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden;
    clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

  /* Hide number spinners (amount/rate/hours) */
  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
  input[type=number]{ -moz-appearance:textfield; appearance:textfield; }

  /* Placeholder styling for the £ hint */
  input::placeholder{ color:var(--muted); opacity:.75; }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce){ :root{ --motion:0 } }
  [data-anim]{ transition: transform .2s ease, opacity .2s ease; }
  html.reduce-motion [data-anim]{ transition:none !important }

  /* PRINT (Illustration-only @ 80%) */
  @page{ size:A4; margin:12mm }
  @media print{
    body{ background:#fff; color:#000 }
    .header, .panel, .kpi, .card{ border-color:#000 }
    html.print-illustration .header,
    html.print-illustration #inputs,
    html.print-illustration #disclaimer,
    html.print-illustration #admin,
    html.print-illustration footer{ display:none !important }
    html.print-illustration #payslipPanel{ display:block !important }
    html.print-illustration .wrap{ transform:scale(.8); transform-origin:top left; width:calc(100%/.8) }
    html.print-illustration body{ zoom:.8 }
  }
</style>

</head>
<body>
  <a href="#main" class="skip">Skip to main content</a>
  <div class="wrap">
    <!-- Header -->
    <header class="header" role="banner">
      <div>
        <h1>NHS Pension Opt-Out Calculator (England only)</h1>
        <p class="small" style="margin:0">Monthly payslip illustration — <b>stay in</b> vs <b>opt out</b>. NI inferred from <b>DOB</b>.</p>
      </div>

      <div class="a11y-bar" aria-label="Accessibility controls">
        <span id="a11yBadge" class="a11y-badge" role="status" aria-live="polite">Accessibility Mode Enabled</span>

        <div class="a11y-group" role="group" aria-label="Theme">
          <span class="a11y-label">Theme</span>
          <select id="themeSelect" title="Theme selector">
            <option value="auto">Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
            <option value="hc">High contrast</option>
            <option value="hc-large">High contrast (Large)</option>
          </select>
        </div>

        <div class="a11y-group" role="group" aria-label="Readability">
          <label class="a11y-label"><input id="toggleFont" type="checkbox"> Larger text</label>
          <label class="a11y-label"><input id="toggleMotion" type="checkbox"> Reduce motion</label>
        </div>

        <button id="btnPrintIllo" class="btn primary" type="button" aria-label="Print payslip illustration">Print illustration</button>

        <!-- Admin toggles appear automatically when ?admin=1 or ?a11y=1 -->
        <button id="btnAdmin" class="btn hide" aria-label="Open admin panel" aria-expanded="false" aria-controls="admin" type="button">Admin</button>
        <button id="btnANDI" class="btn hide" type="button" aria-label="Run ANDI accessibility checker" aria-describedby="andiNote">ANDI</button>
      </div>
      <p id="andiNote" class="small hide" aria-hidden="true" style="margin:0.5rem 0 0">ANDI runs locally from your <code>/andi/</code> folder. No data is sent externally.</p>
    </header>

    <!-- Disclaimer -->
    <section id="disclaimer" class="panel" aria-label="Disclaimer">
      <div class="note small">
        <b>Illustration, not payroll.</b> ESR uses YTD (cumulative) PAYE/NI, rounding and other deductions, so results will differ.
        <span>For personalised information, contact the <b>LAS Pensions Department</b> or NHS Pensions.</span>
      </div>
    </section>

    <main id="main" tabindex="-1">
      <!-- Inputs -->
      <section id="inputs" class="panel grid2" aria-label="Inputs">
        <div>
          <h2 style="margin-top:0; font-weight:var(--heading-w)">Pensionable pay (monthly)</h2>
          <div id="items"></div>
          <div class="actions" style="margin-top:8px">
            <button id="addItem" class="btn" type="button">+ Add item</button>
            <button id="clearItems" class="btn" type="button">Clear</button>
          </div>
          <div class="space" style="border-top:2px solid var(--border); padding-top:10px; margin-top:10px">
            <div class="muted">Total monthly pensionable pay</div>
            <div id="totalPay" style="font-weight:800" aria-live="polite">£0.00</div>
          </div>
        </div>

        <div>
          <h2 style="margin-top:0; font-weight:var(--heading-w)">Your details</h2>
          <div class="row">
            <label class="cs6" for="dob"><span class="small">Date of birth</span>
              <input id="dob" type="date" />
            </label>
            <label class="cs6" for="taxCode"><span class="small">Tax code (optional)</span>
              <input id="taxCode" type="text" placeholder="1257L, BR, D0, D1, NT" value="1257L" />
            </label>
          </div>
          <p class="small muted" style="margin-top:8px">Assumes NHS “net pay arrangement”.</p>
        </div>
      </section>

      <!-- Payslip Illustration -->
      <section id="payslipPanel" class="panel" aria-label="Payslip illustration">
        <h2 style="margin-top:0; font-weight:var(--heading-w)">Payslip illustration (monthly)</h2>
        <div class="note small" style="margin-bottom:10px">
          <ul style="margin:0 0 0 16px">
            <li><b>Payments</b> shows each pensionable item you entered.</li>
            <li><b>Deductions</b> show NHS Pension, PAYE and NI. The PAYE line shows taxable pay used.</li>
          </ul>
        </div>

        <div class="payslip" data-anim>
          <!-- Stay in -->
          <div class="card">
            <div style="font-weight:800; margin-bottom:6px">Stay in</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
              <div>
                <div class="muted" style="font-weight:700; margin-bottom:4px">Payments</div>
                <div id="stayPayments"></div>
                <div class="space tot"><div>Total payments</div><div id="stayTotalPayments" aria-live="polite">£0.00</div></div>
              </div>
              <div>
                <div class="muted" style="font-weight:700; margin-bottom:4px">Deductions</div>
                <div class="space"><div>NHS Pension <span id="nhsRate">(0.0%)</span></div><div id="stayNhs">£0.00</div></div>
                <div class="space"><div>PAYE <span class="small muted">(Taxable pay used: <span id="stayTaxable">£0.00</span>)</span></div><div id="stayTax">£0.00</div></div>
                <div class="space"><div>National Insurance</div><div id="stayNi">£0.00</div></div>
                <div class="space tot"><div>Total deductions</div><div id="stayTotalDeds" aria-live="polite">£0.00</div></div>
              </div>
            </div>
            <div class="space" style="margin-top:10px; font-weight:800"><div>Net pay</div><div id="stayNet" aria-live="polite">£0.00</div></div>
          </div>

          <!-- Opt out -->
          <div class="card">
            <div style="font-weight:800; margin-bottom:6px">Opt out</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
              <div>
                <div class="muted" style="font-weight:700; margin-bottom:4px">Payments</div>
                <div id="outPayments"></div>
                <div class="space tot"><div>Total payments</div><div id="outTotalPayments" aria-live="polite">£0.00</div></div>
              </div>
              <div>
                <div class="muted" style="font-weight:700; margin-bottom:4px">Deductions</div>
                <div class="space"><div>NHS Pension</div><div>£0.00</div></div>
                <div class="space"><div>PAYE <span class="small muted">(Taxable pay used: <span id="outTaxable">£0.00</span>)</span></div><div id="outTax">£0.00</div></div>
                <div class="space"><div>National Insurance</div><div id="outNi">£0.00</div></div>
                <div class="space tot"><div>Total deductions</div><div id="outTotalDeds" aria-live="polite">£0.00</div></div>
              </div>
            </div>
            <div class="space" style="margin-top:10px; font-weight:800"><div>Net pay</div><div id="outNet" aria-live="polite">£0.00</div></div>
          </div>
        </div>

        <!-- KPIs + Benefits -->
        <div style="display:grid; gap:12px; grid-template-columns:1fr; margin-top:12px" data-anim>
          <div class="kpi">
            <div class="small muted">Difference in take-home (opt-out minus stay-in)</div>
            <div id="delta" style="font-size:20px; font-weight:800" aria-live="polite">£0.00</div>
          </div>
          <div class="kpi">
            <div class="small muted">Net annual pay — stay in / opt out</div>
            <div id="netAnnual" style="font-size:18px; font-weight:800" aria-live="polite">£0.00 / £0.00</div>
          </div>

          <!-- WHAT YOU’D BE GIVING UP -->
          <div class="kpi" id="benefits">
            <div class="small muted">Employer pension (context)</div>
            <div id="employerPension" style="font-size:18px; font-weight:800" aria-live="polite">≈ £0.00/yr</div>
            <div class="small muted">Not deducted from pay but foregone if you opt out.</div>

            <div class="note" style="margin-top:12px">
              <div style="font-weight:700; margin-bottom:6px">
                Benefits you will be giving up by opting out of the <span id="benefitSchemeLabel">2015 NHS Pension Scheme</span>
              </div>
              <ul class="small" style="margin:0 0 0 18px">
                <li>Based on your current pensionable earnings, you would give up an <b>annual pension accrual</b> of around
                  <b><span id="benefitAccrual">£0.00/yr</span></b> for life after retirement.</li>
                <li>To illustrate the value of the NHS pension you would be giving up, buying similar benefits on the
                  “open market” could cost around <b><span id="benefitMarketCost">£0.00</span></b> for <i>each year</i> you give up accruing benefits.</li>
                <li>An annual pension payable for life after retirement.</li>
                <li>Tax-free cash lump sum on retirement for those with 1995 Section membership (optional for other 2015 members).</li>
                <li>Death-in-service life assurance lump sum payable to nominated people or an organisation.</li>
                <li>Pension benefits payable to dependants, including children and surviving partners.</li>
                <li>Ill-health retirement benefits.</li>
                <li>Tax relief on pension contributions.</li>
              </ul>
              <p class="small" style="margin:10px 0 0">
                More information is available in the NHS Pension Scheme Guide at
                <a href="https://www.nhsbsa.nhs.uk/sites/default/files/2024-05/2015%20Members%20Guide%20%28V13%29%2005.2024.pdf" target="_blank" rel="noopener">nhsbsa.nhs.uk/nhs-pensions</a>.
                This is an illustration and excludes revaluation, survivor benefits calculations, early/late retirement factors and personal tax circumstances.
              </p>
            </div>
          </div>
          <!-- /WHAT YOU’D BE GIVING UP -->
        </div>
      </section>
    </main>

    <!-- Admin -->
    <section id="admin" class="panel hide" aria-label="Admin">
      <h2 style="margin-top:0">Admin — Rates (paste/edit yearly)</h2>
      <p class="small muted">Edits save to this browser (localStorage). Export and commit when ready.</p>
      <div class="grid2">
        <div>
          <label class="small" for="ratesCurrent">Current JSON</label>
          <textarea id="ratesCurrent" rows="16" readonly style="width:100%; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; border:2px solid var(--border); border-radius:8px; padding:8px"></textarea>
          <div class="actions" style="margin-top:8px">
            <button id="exportRates" class="btn" type="button" aria-label="Export current rates to file">Export</button>
          </div>
        </div>
        <div>
          <label class="small" for="ratesPaste">Paste new JSON</label>
          <textarea id="ratesPaste" rows="16" placeholder='{ "years":[ ... ], "defaultYear":"2025/26" }' style="width:100%; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; border:2px solid var(--border); border-radius:8px; padding:8px"></textarea>
          <div class="actions" style="margin-top:8px">
            <button id="importRates" class="btn" type="button" aria-label="Import rates from JSON">Import</button>
          </div>
        </div>
      </div>
      <p id="andiNote2" class="small muted hide">ANDI is available via the header when in admin mode.</p>
    </section>

    <footer class="small muted" style="margin:12px 0 24px">
      HMRC PAYE & NI 2025/26; NHSBSA member tiers 2025/26. For guidance only.
    </footer>
  </div>

  <script>
  /* ---------- Rates data (fallback if no localStorage) ---------- */
  const defaultRates = {
    defaultYear: "2025/26",
    years: [{
      label: "2025/26",
      tax: {
        personalAllowance: 12570,
        higherRateThreshold: 37700,
        additionalRateThreshold: 125140,
        bands: { ENG_NI: [ {upper:37700,rate:.20},{upper:125140,rate:.40},{upper:null,rate:.45} ] }
      },
      ni: { monthly: { LEL: 542, PT: 1048, UEL: 4189 }, employeeRates: { main: .08, upper: .02 } },
      nhs: {
        tiers: [
          { min: 0, max: 13259, rate: 0.052 },
          { min: 13260, max: 27797, rate: 0.065 },
          { min: 27798, max: 33868, rate: 0.083 },
          { min: 33869, max: 50845, rate: 0.098 },
          { min: 50846, max: 65190, rate: 0.107 },
          { min: 65191, max: null,  rate: 0.125 }
        ],
        employerRateHint: 0.237
      },
      /* Benefits block used to compute the "giving up" examples */
      benefits: {
        schemeLabel: "2015 NHS Pension Scheme (CARE 1/54th)",
        accrualFraction: "1/54",
        annuityFactor: 18
      }
    }]
  };

  /* ---------- Storage / formatting / theme ---------- */
  const THEME_KEY='las_optout_theme', FONT_KEY='las_optout_fontscale', MOTION_KEY='las_optout_motion';
  function loadRates(){ try{const raw=localStorage.getItem('las_optout_rates_v1'); if(!raw) return defaultRates; const p=JSON.parse(raw); return p?.years?.length?p:defaultRates;}catch{return defaultRates;} }
  function saveRates(r){ localStorage.setItem('las_optout_rates_v1', JSON.stringify(r,null,2)); }
  const GBP = new Intl.NumberFormat('en-GB',{style:'currency', currency:'GBP'});
  const fmt = n => GBP.format((+n)||0), pct = n => `${(n*100).toFixed(1)}%`;

  /* Theme + readability toggles */
  function applyTheme(v){
    document.documentElement.classList.remove('theme-light','theme-dark','theme-hc','theme-hc-large');
    if(v==='light') document.documentElement.classList.add('theme-light');
    else if(v==='dark') document.documentElement.classList.add('theme-dark');
    else if(v==='hc') document.documentElement.classList.add('theme-hc');
    else if(v==='hc-large') document.documentElement.classList.add('theme-hc-large');
  }
  function applyFontToggle(on){ document.documentElement.style.setProperty('--scale', on?'1.12':'1'); }
  function applyMotionToggle(on){ document.documentElement.classList.toggle('reduce-motion', on); }

  (function initA11y(){
    const themeSel=document.getElementById('themeSelect');
    const savedTheme=localStorage.getItem(THEME_KEY)||'auto';
    themeSel.value=savedTheme; applyTheme(savedTheme);
    themeSel.addEventListener('change',()=>{ const v=themeSel.value; localStorage.setItem(THEME_KEY,v); applyTheme(v); });

    const fontBox=document.getElementById('toggleFont');
    const motionBox=document.getElementById('toggleMotion');
    const savedFont=localStorage.getItem(FONT_KEY)==='1';
    const savedMotion=localStorage.getItem(MOTION_KEY)==='1';
    fontBox.checked=savedFont; motionBox.checked=savedMotion;
    applyFontToggle(savedFont); applyMotionToggle(savedMotion);
    fontBox.addEventListener('change',()=>{ localStorage.setItem(FONT_KEY, fontBox.checked?'1':'0'); applyFontToggle(fontBox.checked); });
    motionBox.addEventListener('change',()=>{ localStorage.setItem(MOTION_KEY, motionBox.checked?'1':'0'); applyMotionToggle(motionBox.checked); });
  })();

  /* ---------- Helpers ---------- */
  function parseTaxCode(code){
    const c=(code||'').toUpperCase().trim();
    if(!c) return {mode:'STANDARD', allowance:12570};
    if(['BR','D0','D1','NT'].includes(c)) return {mode:c};
    const m=c.match(/(\d{3,4})[A-Z]*/);
    if(m) return {mode:'STANDARD', allowance:parseInt(m[1],10)*10};
    return {mode:'STANDARD', allowance:12570};
  }
  function ageOnDate(dob,on){
    if(!dob) return null;
    const b=new Date(dob); if(isNaN(b)) return null;
    let a=on.getFullYear()-b.getFullYear(); const m=on.getMonth()-b.getMonth();
    if(m<0 || (m===0 && on.getDate()<b.getDate())) a--;
    return a;
  }
  function nhsRateFor(annual, nhs){
    const t = nhs.tiers.find(x => annual>=x.min && (x.max===null || annual<=x.max));
    return t ? t.rate : 0;
  }
  function calcPAYE(mTax, ani, tcfg, parsed){
    const pa0 = parsed.mode==='STANDARD' ? parsed.allowance : 0;
    const taper = Math.max(0, Math.floor((Math.max(ani,0)-100000)/2));
    const pa = parsed.mode==='STANDARD' ? Math.max(0, pa0 - taper) : 0;
    if(parsed.mode==='NT') return 0;
    if(parsed.mode==='BR') return mTax*0.20;
    if(parsed.mode==='D0') return mTax*0.40;
    if(parsed.mode==='D1') return mTax*0.45;
    let remaining = Math.max(0, mTax - pa/12), tax=0, lowerA=0;
    const bands = tcfg.bands.ENG_NI;
    for(const b of bands){
      const upperA=(b.upper==null?Infinity:b.upper), sizeM=(upperA-lowerA)/12;
      const take=Math.max(0, Math.min(remaining, sizeM));
      tax += take*b.rate; remaining -= take; lowerA = upperA;
      if(remaining<=0) break;
    }
    if(remaining>0) tax += remaining * bands[bands.length-1].rate;
    return tax;
  }
  function calcNI(mGross, ncfg, overSPA){
    if(overSPA) return 0;
    const {PT, UEL} = ncfg.monthly;
    if(mGross<=PT) return 0;
    const between = Math.max(0, Math.min(mGross, UEL)-PT);
    const above   = Math.max(0, mGross-UEL);
    return between*ncfg.employeeRates.main + above*ncfg.employeeRates.upper;
  }

  /* ---------- State & DOM ---------- */
  const state = { items:[], rates:loadRates(), year:null }; state.year = state.rates.years[0];

  const elItems = document.getElementById('items');
  const elAdd = document.getElementById('addItem');
  const elClear = document.getElementById('clearItems');
  const elDob = document.getElementById('dob');
  const elTax = document.getElementById('taxCode');
  const elStayPayments = document.getElementById('stayPayments');
  const elOutPayments  = document.getElementById('outPayments');

  /* Admin mode (ANDI auto-load + banner) */
  const params = new URLSearchParams(location.search);
  const isAdmin = params.get('admin')==='1' || params.get('a11y')==='1';
  const btnAdmin = document.getElementById('btnAdmin');
  const adminSec = document.getElementById('admin');
  const ratesCurrent = document.getElementById('ratesCurrent');
  const ratesPaste = document.getElementById('ratesPaste');
  const btnImport = document.getElementById('importRates');
  const btnExport = document.getElementById('exportRates');
  const btnANDI = document.getElementById('btnANDI');
  const andiNote = document.getElementById('andiNote');
  const a11yBadge = document.getElementById('a11yBadge');

  if(isAdmin){
    btnAdmin.classList.remove('hide');
    btnANDI.classList.remove('hide');
    andiNote.classList.remove('hide');
    andiNote.setAttribute('aria-hidden','false');
    a11yBadge.style.display='inline-block';

    // Auto-load ANDI (expects /andi/andi.js in same site)
    (function autoLoadANDI(){
      if(window.ANDI){ window.ANDI.init(); return; }
      const s=document.createElement('script');
      s.src='andi/andi.js';
      s.onload=()=>{ try{ window.ANDI && window.ANDI.init(); }catch(e){ console.warn('ANDI present but init failed', e); } };
      s.onerror=()=>console.warn('Could not load ANDI. Check the /andi/ folder path.');
      document.body.appendChild(s);
    })();
  }
  btnANDI?.addEventListener('click', ()=>{
    if(window.ANDI){ window.ANDI.init(); return; }
    const s=document.createElement('script');
    s.src='andi/andi.js'; s.onload=()=>window.ANDI && window.ANDI.init();
    s.onerror=()=>alert('Could not load ANDI. Check the andi/ folder path.');
    document.body.appendChild(s);
  });

  function refreshAdminText(){ if(ratesCurrent) ratesCurrent.value = JSON.stringify(state.rates,null,2); }
  btnAdmin?.addEventListener('click',()=>{
    adminSec.classList.toggle('hide');
    const ex = btnAdmin.getAttribute('aria-expanded')==='true';
    btnAdmin.setAttribute('aria-expanded', String(!ex));
    refreshAdminText();
  });
  btnImport?.addEventListener('click',()=>{
    try{
      const p = JSON.parse(ratesPaste.value);
      if(!p?.years?.length) throw new Error('Malformed JSON');
      state.rates = p; state.year = p.years[0]; saveRates(p);
      ratesPaste.value=''; refreshAdminText(); render();
      alert('Rates imported.');
    }catch(e){ alert('Import failed: '+e.message); }
  });
  btnExport?.addEventListener('click',()=>{
    const blob = new Blob([JSON.stringify(state.rates,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='las-optout-rates.json'; a.click();
    URL.revokeObjectURL(url);
  });

  /* Print Illustration-only (80%) */
  const btnPrintIllo = document.getElementById('btnPrintIllo');
  function enablePrintFlags(){ document.documentElement.classList.add('print-illustration'); }
  function disablePrintFlags(){ document.documentElement.classList.remove('print-illustration'); }
  window.addEventListener('afterprint', disablePrintFlags);
  btnPrintIllo.addEventListener('click', ()=>{ enablePrintFlags(); setTimeout(()=>window.print(),50); setTimeout(disablePrintFlags,2000); });

  /* Pay item row builder (accessible, no duplicate labels) */
  let idSeq=0;
  function itemRow(it){
    const row=document.createElement('div'); row.className='row'; row.dataset.id=it.id;

    const nameId   = `name-${it.id}`;
    const chkId    = `mode-${it.id}`;
    const rateId   = `rate-${it.id}`;
    const hoursId  = `hours-${it.id}`;
    const amountId = `amount-${it.id}`;

    const nameLabel=document.createElement('label'); nameLabel.className='cs4 sr-only'; nameLabel.htmlFor=nameId; nameLabel.textContent='Pay item name';
    const name=document.createElement('input'); name.className='cs4'; name.id=nameId; name.value=it.label;
    name.addEventListener('input',()=>{ it.label=name.value; render(); });

    const chkWrap=document.createElement('div'); chkWrap.className='cs3'; chkWrap.style.display='flex'; chkWrap.style.alignItems='center'; chkWrap.style.gap='8px';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.id=chkId; chk.checked=!!it.useRate;
    const chkLbl=document.createElement('label'); chkLbl.setAttribute('for',chkId); chkLbl.className='small'; chkLbl.textContent='rate × hours';
    chkWrap.append(chk, chkLbl);

    const rateLabel=document.createElement('label'); rateLabel.className='sr-only'; rateLabel.htmlFor=rateId; rateLabel.textContent='Hourly rate (£)';
    const rate=document.createElement('input'); rate.type='number'; rate.placeholder='rate'; rate.className='cs2'; rate.step='0.01'; rate.min='0'; rate.id=rateId; rate.value=it.rate ?? '';

    const hoursLabel=document.createElement('label'); hoursLabel.className='sr-only'; hoursLabel.htmlFor=hoursId; hoursLabel.textContent='Hours in month';
    const hours=document.createElement('input'); hours.type='number'; hours.placeholder='hours'; hours.className='cs2'; hours.step='0.01'; hours.min='0'; hours.id=hoursId; hours.value=it.hours ?? '';

    const amountLabel=document.createElement('label'); amountLabel.className='sr-only'; amountLabel.htmlFor=amountId; amountLabel.textContent='Total amount (£)';
    const amount=document.createElement('input'); amount.type='number'; amount.className='cs6'; amount.step='0.01'; amount.min='0'; amount.id=amountId; amount.value=it.amount;

    const preview=document.createElement('div'); preview.className='cs1 small'; preview.style.textAlign='right'; preview.style.opacity='.7';
    const remove=document.createElement('button'); remove.className='cs1 btn'; remove.type='button'; remove.textContent='×';
    remove.setAttribute('aria-label', `Remove pay item ${it.label||''}`.trim());
    remove.addEventListener('click', ()=>{ state.items = state.items.filter(x=>x.id!==it.id); render(); });

    function toggleMode(){
      if(chk.checked){
        rate.classList.remove('hide'); hours.classList.remove('hide'); amount.classList.add('hide');
        preview.textContent = GBP.format((it.rate||0)*(it.hours||0));
        it.useRate = true;
      }else{
        rate.classList.add('hide'); hours.classList.add('hide'); amount.classList.remove('hide');
        preview.textContent = ''; it.useRate = false;
      }
    }
    chk.addEventListener('change', ()=>{ toggleMode(); render(); });
    rate.addEventListener('input', ()=>{ it.rate = parseFloat(rate.value||'0'); render(); });
    hours.addEventListener('input', ()=>{ it.hours = parseFloat(hours.value||'0'); render(); });
    amount.addEventListener('input', ()=>{ it.amount = parseFloat(amount.value||'0'); render(); });

    toggleMode();

    row.append(
      nameLabel, name,
      chkWrap,
      rateLabel, rate,
      hoursLabel, hours,
      amountLabel, amount,
      preview, remove
    );
    return row;
  }
  function addItem(label='Other', amount=0){
    const it={ id:'it-'+(idSeq++), label, amount, useRate:false, rate:null, hours:null };
    state.items.push(it); elItems.appendChild(itemRow(it)); render();
  }
  function rebuildItems(){ elItems.innerHTML=''; state.items.forEach(it=>elItems.appendChild(itemRow(it))); }
  elAdd.addEventListener('click',()=> addItem('Other',0));
  elClear.addEventListener('click',()=>{ state.items=[]; rebuildItems(); render(); });
  addItem('Basic',0); addItem('HCA',0);

  /* Core render */
  function parseAccrualFraction(frac){
    if(typeof frac==='string'){
      const m=frac.trim().match(/^(\d+)\s*\/\s*(\d+)$/);
      if(m){ const num=+m[1], den=+m[2]; if(den>0) return {num,den}; }
    }
    return {num:1, den:54};
  }

  function render(){
    const monthlyGross = state.items.reduce((s,it)=> s + (it.useRate ? (it.rate||0)*(it.hours||0) : (+it.amount||0)), 0);
    document.getElementById('totalPay').textContent = fmt(monthlyGross);

    const annualGross = monthlyGross*12;
    const nhsR = nhsRateFor(annualGross, state.year.nhs);
    document.getElementById('nhsRate').textContent = '('+pct(nhsR)+')';
    const monthlyNhs = (annualGross*nhsR)/12;

    const monthEnd=new Date(); monthEnd.setMonth(monthEnd.getMonth()+1,0);
    const overSPA = (ageOnDate(elDob.value, monthEnd)??0) >= 66;

    const parsed = parseTaxCode(elTax.value);
    const aniStay = Math.max(0, annualGross - annualGross*nhsR);
    const taxableStay = Math.max(0, monthlyGross - monthlyNhs);

    const taxStay = calcPAYE(taxableStay, aniStay, state.year.tax, parsed);
    const taxOut  = calcPAYE(monthlyGross, annualGross, state.year.tax, parsed);
    const niStay  = calcNI(monthlyGross, state.year.ni, overSPA);
    const niOut   = calcNI(monthlyGross, state.year.ni, overSPA);

    const netStay = monthlyGross - monthlyNhs - taxStay - niStay;
    const netOut  = monthlyGross - taxOut - niOut;
    const delta   = netOut - netStay;

    function fill(container){
      container.innerHTML='';
      state.items.forEach(it=>{
        const v = it.useRate ? (it.rate||0)*(it.hours||0) : (+it.amount||0);
        if(!v) return;
        const row=document.createElement('div'); row.className='space';
        row.innerHTML = `<div>${it.label}</div><div>${fmt(v)}</div>`;
        container.appendChild(row);
      });
    }
    fill(elStayPayments); fill(elOutPayments);

    document.getElementById('stayTotalPayments').textContent = fmt(monthlyGross);
    document.getElementById('outTotalPayments').textContent  = fmt(monthlyGross);

    document.getElementById('stayNhs').textContent = fmt(monthlyNhs);
    document.getElementById('stayTax').textContent = fmt(taxStay);
    document.getElementById('stayNi').textContent  = fmt(niStay);
    document.getElementById('stayTotalDeds').textContent = fmt(monthlyNhs + taxStay + niStay);
    document.getElementById('stayNet').textContent = fmt(netStay);
    document.getElementById('stayTaxable').textContent = fmt(taxableStay);

    document.getElementById('outTax').textContent = fmt(taxOut);
    document.getElementById('outNi').textContent  = fmt(niOut);
    document.getElementById('outTotalDeds').textContent = fmt(taxOut + niOut);
    document.getElementById('outNet').textContent = fmt(netOut);
    document.getElementById('outTaxable').textContent = fmt(monthlyGross);

    const elDelta = document.getElementById('delta');
    elDelta.textContent = fmt(delta);
    elDelta.className = 'text-' + (delta>=0 ? 'green' : 'red');
    document.getElementById('netAnnual').textContent = fmt(netStay*12) + ' / ' + fmt(netOut*12);

    // Employer context
    const employerAnnual = annualGross * (state.year.nhs.employerRateHint||0);
    document.getElementById('employerPension').textContent = '≈ ' + fmt(employerAnnual) + '/yr';

    // Benefits illustration (reads from JSON, falls back if missing)
    const b = (state.year && state.year.benefits) ? state.year.benefits : {
      schemeLabel: '2015 NHS Pension Scheme (CARE 1/54th)',
      accrualFraction: '1/54',
      annuityFactor: 18
    };
    const {num,den} = parseAccrualFraction(b.accrualFraction||'1/54');
    const accrualPerYear = (annualGross * (num/den));               // £/yr pension added this year
    const marketCostThisYear = accrualPerYear * (b.annuityFactor||18);
    document.getElementById('benefitSchemeLabel').textContent = b.schemeLabel || '2015 NHS Pension Scheme (CARE 1/54th)';
    document.getElementById('benefitAccrual').textContent = fmt(accrualPerYear) + '/yr';
    document.getElementById('benefitMarketCost').textContent = fmt(marketCostThisYear);

    if(getComputedStyle(document.documentElement).getPropertyValue('--motion')!=='0'){
      document.querySelectorAll('[data-anim]').forEach(n=>{
        n.style.transform='scale(1.001)'; n.style.opacity='0.99';
        setTimeout(()=>{ n.style.transform=''; n.style.opacity=''; },120);
      });
    }

    refreshAdminText();
  }

  // Input listeners + initial render
  elDob.addEventListener('input', render);
  elTax.addEventListener('input', render);
  render();
  </script>
</body>
</html>
