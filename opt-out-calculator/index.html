<!DOCTYPE html>
<html lang="en-GB" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex, nofollow, noarchive" />
  <title>LAS PAYE & Pension Estimator — Month 1 (Optional ESR Mode)</title>
  <!-- Favicon: £ symbol to match Contribution Rate Checker -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23023020'/%3E%3Ctext x='16' y='22' font-family='Arial, Helvetica, sans-serif' font-size='18' font-weight='700' text-anchor='middle' fill='white'%3E%C2%A3%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #f6f8fb;
      --text: #0f1720;
      --muted: #5b6776;
      --accent: #023020; /* LAS green */
      --card-bg: #ffffff; /* White cards */
      --card-border: #e6e9ef;
      --input-bg: #ffffff;
      --input-border: #d7dbe3;
      --shadow: 0 1px 2px rgba(16, 24, 40, 0.04), 0 6px 20px rgba(16, 24, 40, 0.06);
    }
    [data-theme="dark"] {
      --bg: #0c1116; --text: #eaf0f6; --muted: #98a2af; --accent: #74c69d;
      --card-bg: #ffffff; --card-border: #e6e9ef; --input-bg: #ffffff; --input-border: #d7dbe3;
      --shadow: 0 1px 2px rgba(0,0,0,0.25), 0 8px 24px rgba(0,0,0,0.35);
    }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    .title { display:flex; align-items:center; gap:10px; }
    .title h1 { font-size:22px; margin:0; color:var(--accent); }
    .badge { font-size:12px; padding:4px 8px; border:1px solid var(--card-border); border-radius:999px; background:#fff; color:#333; }

    .card { background:var(--card-bg); border:1px solid var(--card-border); border-radius:14px; box-shadow:var(--shadow); padding:16px; margin-top:14px; }
    .card h2 { margin:0 0 12px 0; font-size:18px; color:#111; }
    .card p.hint { margin:8px 0 0 0; font-size:12px; color:#4b5563; }

    .grid { display:grid; grid-template-columns:repeat(12,1fr); gap:12px; }
    .col-12 { grid-column:span 12; } .col-6 { grid-column:span 6; }
    .col-4 { grid-column:span 4; } .col-3 { grid-column:span 3; }
    @media (max-width:860px){ .col-6,.col-4,.col-3 { grid-column:span 12; } }

    label { display:block; font-size:13px; margin:6px 0; color:#111; }
    input[type="number"],input[type="text"],input[type="date"],select{
      width:100%; background:var(--input-bg); color:#111; border:1px solid var(--input-border);
      border-radius:10px; padding:10px 12px; font-size:14px;
    }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .switch{ display:inline-flex; align-items:center; gap:8px; font-size:14px; }
    .switch input{ transform:scale(1.1); }
    button{ appearance:none; border:1px solid var(--accent); color:#fff; background:var(--accent); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    button.secondary{ background:transparent; color:var(--accent); }

    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th,td{ text-align:left; padding:10px 8px; border-bottom:1px dashed #e5e7eb; }
    th{ color:#111; font-weight:600; background:#fafafa; }
    .note{ font-size:12px; color:var(--muted); margin-top:8px; }

    [data-theme="dark"] .card { color:#111; }
    [data-theme="dark"] .card h2 { color:#111; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <rect x="2" y="3" width="20" height="18" rx="3" stroke="#023020" stroke-width="1.6"/>
          <path d="M7 8h10M7 12h10M7 16h6" stroke="#023020" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <h1>NHS PAYE & Pension Estimator</h1>
        <span class="badge">Month 1 by default • ESR (cumulative) optional</span>
      </div>
      <div class="row">
        <label class="switch"><input id="themeToggle" type="checkbox"> Dark mode</label>
      </div>
    </div>

    <div class="card">
      <h2>Inputs</h2>
      <div class="grid">
        <div class="col-3">
          <label for="pensionablePay">Pensionable pay this month (£)</label>
          <input id="pensionablePay" type="number" inputmode="decimal" step="0.01" min="0" placeholder="e.g. 2,300" />
        </div>
        <div class="col-3">
          <label for="pensionRate">Employee NHS pension rate (%)</label>
          <input id="pensionRate" type="number" inputmode="decimal" step="0.1" min="0" max="20" placeholder="e.g. 9.8" />
          <p class="hint">Pension is a <strong>pre-tax deduction</strong> (net pay arrangement). It does <strong>not</strong> reduce NI earnings.</p>
        </div>
        <div class="col-3">
          <label for="taxCode">Tax code</label>
          <input id="taxCode" type="text" placeholder="e.g. 1257L M1, 241T, 0T, BR, D0, D1, K400" />
          <p class="hint">Add <strong>M1/W1</strong> to force Month 1. <strong>241T</strong> gives £2,410 annual allowance.</p>
        </div>
        <div class="col-3">
          <label for="dob">Date of birth (for NI)</label>
          <input id="dob" type="date" />
          <p class="hint">If you’re over State Pension age (assumed 66), NI is £0.</p>
        </div>

        <div class="col-12">
          <label class="switch"><input id="esrMode" type="checkbox"> Use ESR cumulative mode (optional)</label>
        </div>

        <div id="esrFields" class="col-12" style="display:none;">
          <div class="grid">
            <div class="col-3">
              <label for="period">Pay period number (1–12)</label>
              <input id="period" type="number" min="1" max="12" value="1" />
            </div>
            <div class="col-4">
              <label for="prevTaxable">Previous taxable pay to date (£)</label>
              <input id="prevTaxable" type="number" step="0.01" min="0" placeholder="before this month" />
            </div>
            <div class="col-4">
              <label for="prevTaxPaid">Previous tax paid to date (£)</label>
              <input id="prevTaxPaid" type="number" step="0.01" min="0" placeholder="before this month" />
            </div>
          </div>
          <p class="hint">Use ESR YTD figures to end of last month. Cumulative bands/free pay are scaled to the period.</p>
        </div>

        <div class="col-12 row">
          <button id="calcBtn">Calculate</button>
          <button id="resetBtn" class="secondary" type="button">Reset</button>
        </div>
      </div>

      <p class="note">Assumptions: England/Wales PAYE & NI for 2025/26 are set in code and can be edited in <code>TAX_CONFIG</code> and <code>NI_CONFIG</code>. Marriage allowance and student loans are not included. K-codes capped so PAYE ≤ 50% of this month’s gross.</p>
    </div>

    <div class="card" id="m1_results">
      <h2>Payslip illustration — Month 1</h2>
      <div class="grid">
        <div class="col-6">
          <h3>Pay</h3>
          <table><tbody>
            <tr><td>Pensionable pay (this month)</td><td id="m1_gross">—</td></tr>
          </tbody></table>
        </div>
        <div class="col-6">
          <h3>Deductions</h3>
          <table><tbody>
            <tr><td>Employee pension (pre-tax)</td><td id="r_pension_m1">—</td></tr>
            <tr><td>PAYE due this month</td><td id="r_tax_m1">—</td></tr>
            <tr><td>National Insurance (Cat A)</td><td id="r_ni_m1">—</td></tr>
          </tbody></table>
        </div>
      </div>
      <table><tbody>
        <tr><th>Taxable pay this month (after pension)</th><td id="r_taxable_m1">—</td></tr>
        <tr><th>Estimated net pay</th><td id="m1_net">—</td></tr>
        <tr><th>Notes</th><td id="r_note_m1">—</td></tr>
      </tbody></table>
    </div>

    <div class="card" id="esr_results" style="display:none;">
      <h2>Payslip illustration — ESR cumulative</h2>
      <div class="grid">
        <div class="col-6">
          <h3>Pay</h3>
          <table><tbody>
            <tr><td>Pensionable pay (this month)</td><td id="esr_gross">—</td></tr>
          </tbody></table>
        </div>
        <div class="col-6">
          <h3>Deductions</h3>
          <table><tbody>
            <tr><td>Employee pension (pre-tax)</td><td id="r_pension_esr">—</td></tr>
            <tr><td>PAYE due this month (ESR calc)</td><td id="r_tax_esr">—</td></tr>
            <tr><td>National Insurance (Cat A)</td><td id="r_ni_esr">—</td></tr>
          </tbody></table>
        </div>
      </div>
      <table><tbody>
        <tr><th>Taxable pay this month (after pension)</th><td id="r_taxable_esr">—</td></tr>
        <tr><th>Estimated net pay</th><td id="esr_net">—</td></tr>
        <tr><th>Notes</th><td id="r_note_esr">—</td></tr>
      </tbody></table>
      <p class="note">Turn on “Use ESR cumulative mode”, enter period + YTD figures, then Calculate.</p>
    </div>

    <div class="card">
      <h2>What changed</h2>
      <ul>
        <li><strong>NI restored</strong> (Cat A) and included in net pay. Pension does not reduce NI.</li>
        <li><strong>DOB</strong> field added; NI set to £0 if over SPA (assumed 66).</li>
        <li><strong>ESR card</strong> now hidden until you enable the toggle.</li>
        <li><strong>No JSON needed:</strong> edit rates in <code>TAX_CONFIG</code>/<code>NI_CONFIG</code>.</li>
      </ul>
    </div>
  </div>

  <script>
    // ---- Configurable PAYE & NI settings (edit here if rates change) ----
    const TAX_CONFIG = {
      year: '2025/26',
      rUK: {
        personalAllowance: 12570,
        basicRateUpper: 37700,        // size of basic band
        additionalRateStart: 125140,  // start of additional rate
        rates: { basic: 0.20, higher: 0.40, additional: 0.45 }
      }
    };

    // NI (Category A) — monthly thresholds (as you used before)
    const NI_CONFIG = {
      monthly: { LEL: 542, PT: 1048, UEL: 4189 },
      rates:   { main: 0.08, upper: 0.02 },
      statePensionAge: 66
    };

    function gbp(n){ return (isFinite(n)) ? new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(n) : '—'; }
    function clamp(n, min, max){ return Math.min(Math.max(n, min), max); }
    function getAgeYears(dobStr){
      if(!dobStr) return null;
      const d = new Date(dobStr); if (isNaN(d)) return null;
      const t = new Date(); let a = t.getFullYear()-d.getFullYear();
      const m = t.getMonth()-d.getMonth(); if (m<0 || (m===0 && t.getDate()<d.getDate())) a--; return a;
    }

    // Tax code parsing
    function parseTaxCode(raw){
      const out={ code:'', allowanceAnnual:0, negativeAllowanceAnnual:0, flatRate:null, nonCumulativeFlag:false, kCode:false };
      if(!raw) return out;
      let s=String(raw).toUpperCase().replace(/\s+/g,'').trim(); out.code=s;
      if (/(M1|W1|X)$/.test(s)) { out.nonCumulativeFlag = true; s = s.replace(/(M1|W1|X)$/,''); }
      if (s==='BR') { out.flatRate=0.20; return out; }
      if (s==='D0') { out.flatRate=0.40; return out; }
      if (s==='D1') { out.flatRate=0.45; return out; }
      if (s==='NT') { out.flatRate=0.00; return out; }
      if (s==='0T' || s==='OT') { out.allowanceAnnual=0; return out; }
      if (/^K\d{1,4}$/.test(s)) { out.kCode=true; out.negativeAllowanceAnnual=parseInt(s.slice(1),10)*10||0; return out; }
      const m=s.match(/^(\d{1,4})([A-Z]*)$/);
      if(m){ out.allowanceAnnual=(parseInt(m[1],10)||0)*10; return out; }
      out.allowanceAnnual=0; return out;
    }

    // Banded tax helper
    function bandedTax(taxable, basicBandSize, addlStart, rates){
      let tax=0;
      const basicPart=clamp(taxable,0,basicBandSize); tax+=basicPart*rates.basic;
      const higherPart=clamp(taxable-basicBandSize,0,addlStart-basicBandSize); tax+=higherPart*rates.higher;
      const addlPart=clamp(taxable-addlStart,0,Infinity); tax+=addlPart*rates.additional;
      return tax;
    }

    // Month-1 PAYE
    function month1PAYE(taxableAfterPension, code, grossForCap){
      const cfg=TAX_CONFIG.rUK;
      if(code.flatRate!==null) return Math.max(0, taxableAfterPension*code.flatRate);
      const mAllow=(code.allowanceAnnual||0)/12, mNeg=(code.negativeAllowanceAnnual||0)/12;
      let adj=Math.max(0, taxableAfterPension - mAllow); if(mNeg>0) adj+=mNeg;
      const basic=cfg.basicRateUpper/12, addlStart=cfg.additionalRateStart/12;
      let tax=bandedTax(adj,basic,addlStart,cfg.rates);
      if(code.kCode){ const cap=0.5*(grossForCap||0); tax=Math.min(tax,cap); }
      return Math.max(0,tax);
    }

    // ESR cumulative PAYE (period-scaled)
    function esrCumulativePAYE(currTaxable, prevTaxableYTD, prevTaxPaidYTD, period, code, grossForCap){
      const cfg=TAX_CONFIG.rUK, p=clamp(parseInt(period,10)||1,1,12);
      if(code.flatRate!==null) return Math.max(0, currTaxable*code.flatRate);
      const ytdTaxable=(prevTaxableYTD||0)+(currTaxable||0);
      const ytdFree=(code.allowanceAnnual||0)*(p/12);
      const ytdNeg=(code.negativeAllowanceAnnual||0)*(p/12);
      let ytdAdj=Math.max(0, ytdTaxable-ytdFree); if(ytdNeg>0) ytdAdj+=ytdNeg;
      const basic=cfg.basicRateUpper*(p/12), addlStart=cfg.additionalRateStart*(p/12);
      let taxYTD=bandedTax(ytdAdj,basic,addlStart,cfg.rates);
      let thisMonth=taxYTD-(prevTaxPaidYTD||0);
      if(code.kCode){ const cap=0.5*(grossForCap||0); thisMonth=Math.min(thisMonth,cap); }
      return Math.max(0,thisMonth);
    }

    // NI (Cat A, monthly). Pension does NOT reduce NI base.
    function monthNI(grossMonthly, dobStr){
      const age=getAgeYears(dobStr);
      if(age!==null && age>=NI_CONFIG.statePensionAge) return 0;
      const {PT,UEL}=NI_CONFIG.monthly, {main,upper}=NI_CONFIG.rates;
      if(grossMonthly<=PT) return 0;
      const between=Math.max(0, Math.min(grossMonthly,UEL)-PT);
      const above=Math.max(0, grossMonthly-UEL);
      return +(between*main + above*upper).toFixed(2);
    }

    // UI wiring
    const els={
      themeToggle:document.getElementById('themeToggle'),
      pensionablePay:document.getElementById('pensionablePay'),
      pensionRate:document.getElementById('pensionRate'),
      taxCode:document.getElementById('taxCode'),
      dob:document.getElementById('dob'),
      esrMode:document.getElementById('esrMode'),
      esrFields:document.getElementById('esrFields'),
      esrCard:document.getElementById('esr_results'),
      period:document.getElementById('period'),
      prevTaxable:document.getElementById('prevTaxable'),
      prevTaxPaid:document.getElementById('prevTaxPaid'),
      calcBtn:document.getElementById('calcBtn'),
      resetBtn:document.getElementById('resetBtn'),
      r:{
        pension_m1:document.getElementById('r_pension_m1'),
        pension_esr:document.getElementById('r_pension_esr'),
        taxable_m1:document.getElementById('r_taxable_m1'),
        taxable_esr:document.getElementById('r_taxable_esr'),
        tax_m1:document.getElementById('r_tax_m1'),
        tax_esr:document.getElementById('r_tax_esr'),
        ni_m1:document.getElementById('r_ni_m1'),
        ni_esr:document.getElementById('r_ni_esr'),
        note_m1:document.getElementById('r_note_m1'),
        note_esr:document.getElementById('r_note_esr')
      }
    };

    els.themeToggle.addEventListener('change',(e)=>{
      document.documentElement.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
    });
    els.esrMode.addEventListener('change',(e)=>{
      const on=e.target.checked; els.esrFields.style.display=on?'block':'none'; els.esrCard.style.display=on?'block':'none';
    });
    els.resetBtn.addEventListener('click',()=>{
      els.pensionablePay.value=''; els.pensionRate.value=''; els.taxCode.value=''; els.dob.value='';
      els.esrMode.checked=false; els.esrFields.style.display='none'; els.esrCard.style.display='none';
      els.period.value=1; els.prevTaxable.value=''; els.prevTaxPaid.value='';
      document.getElementById('m1_gross').textContent='—'; document.getElementById('m1_net').textContent='—';
      document.getElementById('esr_gross').textContent='—'; document.getElementById('esr_net').textContent='—';
      for(const k in els.r) els.r[k].textContent='—';
    });

    els.calcBtn.addEventListener('click', ()=>{
      const gross = parseFloat(els.pensionablePay.value) || 0;
      const rate  = (parseFloat(els.pensionRate.value) || 0) / 100;
      const code  = parseTaxCode(els.taxCode.value);
      const dobStr= els.dob.value || null;

      const pension = Math.max(0, gross*rate);
      const taxableAfterPension = Math.max(0, gross - pension);

      const taxM1 = month1PAYE(taxableAfterPension, code, gross);
      const niM1  = monthNI(gross, dobStr);

      // Outputs — Month 1
      els.r.pension_m1.textContent = gbp(pension);
      els.r.taxable_m1.textContent = gbp(taxableAfterPension);
      els.r.tax_m1.textContent     = gbp(taxM1);
      els.r.ni_m1.textContent      = gbp(niM1);
      document.getElementById('m1_gross').textContent = gbp(gross);
      document.getElementById('m1_net').textContent   = gbp(gross - pension - taxM1 - niM1);

      // ESR cumulative (optional)
      if (els.esrMode.checked) {
        const period = parseInt(els.period.value,10) || 1;
        const prevTaxable = parseFloat(els.prevTaxable.value) || 0;
        const prevTaxPaid = parseFloat(els.prevTaxPaid.value) || 0;
        const taxESR = esrCumulativePAYE(taxableAfterPension, prevTaxable, prevTaxPaid, period, code, gross);

        els.r.pension_esr.textContent = gbp(pension);
        els.r.taxable_esr.textContent = gbp(taxableAfterPension);
        els.r.tax_esr.textContent     = gbp(taxESR);
        els.r.ni_esr.textContent      = gbp(niM1); // NI same in ESR mode
        document.getElementById('esr_gross').textContent = gbp(gross);
        document.getElementById('esr_net').textContent   = gbp(gross - pension - taxESR - niM1);
        els.r.note_esr.textContent = 'ESR cumulative: bands & free pay scaled to period; subtracts tax already paid.';
      } else {
        els.r.pension_esr.textContent = '—';
        els.r.taxable_esr.textContent = '—';
        els.r.tax_esr.textContent     = '—';
        els.r.ni_esr.textContent      = '—';
        els.r.note_esr.textContent    = '—';
      }

      // Month-1 notes
      const notes=[];
      if (code.flatRate!==null){
        if (code.code==='BR') notes.push('BR: all taxable at 20%.');
        if (code.code==='D0') notes.push('D0: all taxable at 40%.');
        if (code.code==='D1') notes.push('D1: all taxable at 45%.');
        if (code.code==='NT') notes.push('NT: no PAYE due.');
      } else {
        if (code.kCode) notes.push('K code: negative free pay added; 50% PAYE cap applied.');
        if (/\d+T$/.test(code.code)) notes.push('T code: allowance from digits (e.g., 241T → £2,410).');
        if (/\d+L$/.test(code.code)) notes.push('1257L → £12,570 allowance (example).');
        if (code.nonCumulativeFlag) notes.push('Non-cumulative flag detected (M1/W1/X).');
      }
      notes.push('NI assumes Category A. Pension does not reduce NI.');
      els.r.note_m1.textContent = notes.join(' ');
    });

    // Quick defaults
    (function init(){
      els.pensionablePay.value = '';
      els.pensionRate.value = '9.8';
      els.taxCode.value = '1257L M1';
    })();
  </script>
</body>
</html>
