<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NHS Pension Opt-Out Calculator (England only)</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23023020'/><text x='50' y='62' font-family='Arial' font-size='60' text-anchor='middle' fill='white'>£</text></svg>'">

  <style>
    :root{
      --brand:#023020; --text:#111; --muted:#4A5568; --bg:#FAFAFA; --panel:#fff; --border:#D6D9DC; --focus:#0B69A3;
      --ok:#1b8555; --warn:#9F3131; --heading-w:800;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1214; --panel:#121618; --text:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; }
    }
    html.theme-light{ --bg:#FAFAFA; --panel:#fff; --text:#111; --muted:#4A5568; --border:#D6D9DC; }
    html.theme-dark{  --bg:#0f1214; --panel:#121618; --text:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; }

    /* High contrast */
    html.theme-hc{ --bg:#fff; --panel:#fff; --text:#000; --muted:#000; --border:#000; --focus:#003a7a; --heading-w:900; }
    html.theme-hc body{ font-size:1.15em; }
    /* High contrast (Large) */
    html.theme-hc-large{ --bg:#fff; --panel:#fff; --text:#000; --muted:#000; --border:#000; --focus:#003a7a; --heading-w:900; }
    html.theme-hc-large body{ font-size:1.25em; }

    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0 }
    body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px; }

    .header{ background:var(--brand); color:#fff; padding:22px 20px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap; }
    .header h1{ margin:0 0 4px 0; font-size:22px; font-weight:var(--heading-w) }

    .panel{ background:var(--panel); border:2px solid var(--border); border-radius:12px; padding:16px; margin-top:16px; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:14px } @media(min-width:860px){ .grid2{ grid-template-columns:1fr 1fr } }
    .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:8px; align-items:end }
    .cs1{grid-column:span 1}.cs2{grid-column:span 2}.cs3{grid-column:span 3}.cs4{grid-column:span 4}.cs6{grid-column:span 6}.cs7{grid-column:span 7}.cs8{grid-column:span 8}.cs12{grid-column:span 12}
    label>span.small{ display:block; font-size:12px; margin-bottom:4px; color:var(--muted) }

    input,select,textarea{ width:100%; border:2px solid var(--border); background:var(--panel); color:var(--text); border-radius:8px; padding:9px 10px; font-weight:600 }
    input:focus,select:focus,textarea:focus{ outline:4px solid var(--focus); outline-offset:2px }

    .btn{ appearance:none; background:var(--panel); color:var(--brand); border:3px solid var(--brand); padding:9px 12px; border-radius:10px; font-weight:800; cursor:pointer }
    .btn:hover{ background:#F0F7F4 }
    .btn.primary{ background:var(--brand); color:#fff }

    .small{ font-size:12px } .muted{ color:var(--muted) }
    .space{ display:flex; justify-content:space-between; align-items:center }

    .payslip{ display:grid; grid-template-columns:1fr; gap:12px } @media(min-width:860px){ .payslip{ grid-template-columns:1fr 1fr } }
    .card{ border:2px solid var(--border); border-radius:12px; padding:12px }
    .tot{ border-top:2px solid var(--border); padding-top:8px; margin-top:8px; font-weight:800 }
    .kpi{ border:2px solid var(--border); border-radius:12px; padding:12px }
    .note{ border:3px solid var(--border); border-left:10px solid var(--brand); border-radius:10px; padding:10px 12px; background:var(--panel); color:var(--text); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .text-green{ color:var(--ok) } .text-red{ color:var(--warn) }
    .hide{ display:none }

    /* ---------- PRINT (single consolidated block to avoid mobile overrides) ---------- */
    @page{ size:A4; margin:12mm }
    @media print{
      body{ background:#fff; color:#000 }
      .header, .panel, .kpi, .card{ border-color:#000; }
      .header{ border-radius:0; }

      /* Default: PRINT SUMMARY */
      .wrap, #admin, #payslipPanel, #disclaimer, #inputs { display:none !important; }
      #printSummary{ display:block !important; }

      /* Illustration-only (80%) when .print-illustration is on <html> */
      html.print-illustration #printSummary{ display:none !important; }
      html.print-illustration .wrap{ display:block !important; }
      html.print-illustration .header,
      html.print-illustration #disclaimer,
      html.print-illustration #inputs,
      html.print-illustration #admin,
      html.print-illustration footer{ display:none !important; }
      html.print-illustration #payslipPanel{ display:block !important; }

      /* Scale to ~80% to fit one A4 page */
      html.print-illustration.print-compact body{ zoom:.8; } /* Chrome/Edge */
      html.print-illustration.print-compact .wrap{
        transform:scale(.8); transform-origin:top left; width:calc(100% /.8); /* Firefox/iOS fallback */
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div>
        <h1>NHS Pension Opt-Out Calculator (England only)</h1>
        <p class="small" style="margin:0">Monthly payslip illustration — <b>stay in</b> vs <b>opt out</b>. NI inferred from <b>DOB</b>.</p>
      </div>
      <div class="actions">
        <label class="small" for="themeSelect" style="color:#fff">Theme</label>
        <select id="themeSelect" title="Theme">
          <option value="auto">Auto</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="hc">High contrast</option>
          <option value="hc-large">High contrast (Large)</option>
        </select>
        <!-- Single print button as requested -->
        <button id="btnPrintIllo80" class="btn primary">Print illustration</button>
        <!-- Admin stays query-guarded -->
        <button id="btnAdmin" class="btn" aria-expanded="false" aria-controls="admin">Admin</button>
      </div>
    </header>

    <!-- Disclaimer -->
    <section id="disclaimer" class="panel" aria-label="Disclaimer">
      <div class="note small">
        <b>Illustration, not payroll.</b> ESR uses YTD (cumulative) PAYE/NI, rounding and other deductions, so results will differ.
        <span>For personalised information, check NHS Pensions or the <b>LAS Pensions Department</b>.</span>
      </div>
    </section>

    <!-- Inputs -->
    <section id="inputs" class="panel grid2" aria-label="Inputs">
      <div>
        <h2 style="margin-top:0; font-weight:var(--heading-w)">Pensionable pay (monthly)</h2>
        <div id="items"></div>
        <div class="actions" style="margin-top:8px">
          <button id="addItem" class="btn" type="button">+ Add item</button>
          <button id="clearItems" class="btn" type="button">Clear</button>
        </div>
        <div class="space" style="border-top:2px solid var(--border); padding-top:10px; margin-top:10px">
          <div class="muted">Total monthly pensionable pay</div>
          <div id="totalPay" style="font-weight:800">£0.00</div>
        </div>
      </div>

      <div>
        <h2 style="margin-top:0; font-weight:var(--heading-w)">Your details</h2>
        <div class="row">
          <label class="cs6"><span class="small">Date of birth</span>
            <input id="dob" type="date" />
          </label>
          <label class="cs6"><span class="small">Tax code (optional)</span>
            <input id="taxCode" type="text" placeholder="1257L, BR, D0, D1, NT" value="1257L" />
          </label>
        </div>
        <p class="small muted" style="margin-top:8px">Assumes NHS “net pay arrangement”.</p>
      </div>
    </section>

    <!-- Payslip Illustration -->
    <section id="payslipPanel" class="panel" aria-label="Payslip illustration">
      <h2 style="margin-top:0; font-weight:var(--heading-w)">Payslip illustration (monthly)</h2>
      <div class="note small" style="margin-bottom:10px">
        <ul style="margin:0 0 0 16px">
          <li><b>Payments</b> shows each pensionable item you entered.</li>
          <li><b>Deductions</b> show NHS Pension, PAYE and NI. The PAYE line shows taxable pay used.</li>
        </ul>
      </div>

      <div class="payslip">
        <!-- Stay in -->
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px">Stay in</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Payments</div>
              <div id="stayPayments"></div>
              <div class="space tot"><div>Total payments</div><div id="stayTotalPayments">£0.00</div></div>
            </div>
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Deductions</div>
              <div class="space"><div>NHS Pension <span id="nhsRate">(0.0%)</span></div><div id="stayNhs">£0.00</div></div>
              <div class="space"><div>PAYE <span class="small muted">(Taxable pay used: <span id="stayTaxable">£0.00</span>)</span></div><div id="stayTax">£0.00</div></div>
              <div class="space"><div>National Insurance</div><div id="stayNi">£0.00</div></div>
              <div class="space tot"><div>Total deductions</div><div id="stayTotalDeds">£0.00</div></div>
            </div>
          </div>
          <div class="space" style="margin-top:10px; font-weight:800"><div>Net pay</div><div id="stayNet">£0.00</div></div>
        </div>

        <!-- Opt out -->
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px">Opt out</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Payments</div>
              <div id="outPayments"></div>
              <div class="space tot"><div>Total payments</div><div id="outTotalPayments">£0.00</div></div>
            </div>
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Deductions</div>
              <div class="space"><div>NHS Pension</div><div>£0.00</div></div>
              <div class="space"><div>PAYE <span class="small muted">(Taxable pay used: <span id="outTaxable">£0.00</span>)</span></div><div id="outTax">£0.00</div></div>
              <div class="space"><div>National Insurance</div><div id="outNi">£0.00</div></div>
              <div class="space tot"><div>Total deductions</div><div id="outTotalDeds">£0.00</div></div>
            </div>
          </div>
          <div class="space" style="margin-top:10px; font-weight:800"><div>Net pay</div><div id="outNet">£0.00</div></div>
        </div>
      </div>

      <!-- KPIs -->
      <div style="display:grid; gap:12px; grid-template-columns:1fr; margin-top:12px">
        <div class="kpi">
          <div class="small muted">Difference in take-home (opt-out minus stay-in)</div>
          <div id="delta" style="font-size:20px; font-weight:800">£0.00</div>
        </div>
        <div class="kpi">
          <div class="small muted">Net annual pay — stay in / opt out</div>
          <div id="netAnnual" style="font-size:18px; font-weight:800">£0.00 / £0.00</div>
        </div>
        <div class="kpi" id="benefits">
          <div class="small muted">Employer pension (context)</div>
          <div id="employerPension" style="font-size:18px; font-weight:800">≈ £0.00/yr</div>
          <div class="small muted">Not deducted from pay but foregone if you opt out.</div>
          <div class="note" style="margin-top:12px">
            <div style="font-weight:700; margin-bottom:6px">Benefits you give up by opting out</div>
            <ul class="small" style="margin:0 0 0 18px">
              <li><span id="benefitEmployer">Employer pension contribution (approx.): £0.00/yr</span></li>
              <li>Future NHS Pension accrual while opted out.</li>
              <li>Death-in-service & survivor benefits linked to active membership.</li>
              <li>Access to ill-health retirement benefits linked to active membership.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="panel hide" aria-label="Admin">
      <h2 style="margin-top:0">Admin — Rates (paste/edit yearly)</h2>
      <p class="small muted">Edits save to this browser (localStorage). Export and commit when ready.</p>
      <div class="grid2">
        <div>
          <label class="small">Current JSON</label>
          <textarea id="ratesCurrent" rows="16" readonly style="width:100%; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; border:2px solid var(--border); border-radius:8px; padding:8px"></textarea>
          <div class="actions" style="margin-top:8px">
            <button id="exportRates" class="btn" type="button">Export</button>
          </div>
        </div>
        <div>
          <label class="small">Paste new JSON</label>
          <textarea id="ratesPaste" rows="16" placeholder='{ "years":[ ... ], "defaultYear":"2025/26" }' style="width:100%; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; border:2px solid var(--border); border-radius:8px; padding:8px"></textarea>
          <div class="actions" style="margin-top:8px">
            <button id="importRates" class="btn" type="button">Import</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="small muted" style="margin:12px 0 24px">
      HMRC PAYE & NI 2025/26; NHSBSA member tiers 2025/26. For guidance only.
    </footer>
  </div>

  <!-- PRINT SUMMARY (still available via browser print if needed) -->
  <section id="printSummary" class="panel hide" aria-label="Print summary">
    <h2 style="margin-top:0; font-weight:var(--heading-w)">NHS Pension Opt-Out Calculator — Summary</h2>
    <div class="small muted" id="printMeta">Generated: —</div>
    <hr style="border:none; border-top:2px solid var(--border); margin:10px 0 12px">
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
      <div>
        <div class="muted" style="font-weight:700; margin-bottom:4px">Payments entered (monthly)</div>
        <div id="printPayments"></div>
        <div class="space tot"><div>Total payments</div><div id="printTotalPayments">£0.00</div></div>
      </div>
      <div>
        <div class="muted" style="font-weight:700; margin-bottom:4px">Key figures</div>
        <div class="space"><div>Net pay — stay in</div><div id="printNetStay">£0.00</div></div>
        <div class="space"><div>Net pay — opt out</div><div id="printNetOut">£0.00</div></div>
        <div class="space"><div>Difference (opt-out − stay-in)</div><div id="printDelta">£0.00</div></div>
        <div class="space"><div>Employer pension (approx.)</div><div id="printEmployer">£0.00/yr</div></div>
        <div class="space"><div>Tax code</div><div id="printTaxCode">—</div></div>
        <div class="space"><div>Date of birth</div><div id="printDob">—</div></div>
      </div>
    </div>
    <div class="note small" style="margin-top:12px">
      <b>Benefits forfeited if you opt out:</b>
      <ul style="margin:4px 0 0 18px">
        <li id="printBenefitEmployer">Employer pension contribution (approx.): £0.00/yr</li>
        <li>Future NHS Pension accrual while opted out (plus in-service revaluation while active).</li>
        <li>Death-in-service lump sum and survivor benefits linked to active membership.</li>
        <li>Access to ill-health retirement benefits linked to active membership (subject to eligibility/assessment).</li>
      </ul>
      <p class="small muted" style="margin:8px 0 0">For personalised information, check NHS Pensions or the <b>LAS Pensions Department</b>.</p>
    </div>
  </section>

  <script>
  /* ---------- Data ---------- */
  const defaultRates = {
    defaultYear: "2025/26",
    years: [{
      label: "2025/26",
      tax: {
        personalAllowance: 12570,
        higherRateThreshold: 37700,
        additionalRateThreshold: 125140,
        bands: { ENG_NI: [ {upper:37700,rate:.20},{upper:125140,rate:.40},{upper:null,rate:.45} ] }
      },
      ni: { monthly: { LEL: 542, PT: 1048, UEL: 4189 }, employeeRates: { main: .08, upper: .02 } },
      nhs: {
        tiers: [
          { min: 0, max: 13259, rate: 0.052 },
          { min: 13260, max: 27797, rate: 0.065 },
          { min: 27798, max: 33868, rate: 0.083 },
          { min: 33869, max: 50845, rate: 0.098 },
          { min: 50846, max: 65190, rate: 0.107 },
          { min: 65191, max: null,  rate: 0.125 }
        ],
        employerRateHint: 0.237
      }
    }]
  };

  /* ---------- Storage & theme ---------- */
  const THEME_KEY='las_optout_theme';
  function loadRates(){ try{const raw=localStorage.getItem('las_optout_rates_v1'); if(!raw) return defaultRates; const p=JSON.parse(raw); return p?.years?.length?p:defaultRates;}catch{return defaultRates;} }
  function saveRates(r){ localStorage.setItem('las_optout_rates_v1', JSON.stringify(r,null,2)); }
  const GBP = new Intl.NumberFormat('en-GB',{style:'currency', currency:'GBP'});
  const fmt = n => GBP.format((+n)||0), pct=n=>`${(n*100).toFixed(1)}%`;

  function parseTaxCode(code){
    const c=(code||'').toUpperCase().trim();
    if(!c) return {mode:'STANDARD', allowance:12570};
    if(['BR','D0','D1','NT'].includes(c)) return {mode:c};
    const m=c.match(/(\d{3,4})[A-Z]*/);
    if(m) return {mode:'STANDARD', allowance:parseInt(m[1],10)*10};
    return {mode:'STANDARD', allowance:12570};
  }
  function ageOnDate(dob,on){ if(!dob) return null; const b=new Date(dob); if(isNaN(b)) return null; let a=on.getFullYear()-b.getFullYear(); const m=on.getMonth()-b.getMonth(); if(m<0||(m===0&&on.getDate()<b.getDate())) a--; return a; }
  function nhsRateFor(annual,nhs){ const t=nhs.tiers.find(x=>annual>=x.min && (x.max===null||annual<=x.max)); return t?t.rate:0; }
  function calcPAYE(mTax, ani, tcfg, parsed){
    const pa0=parsed.mode==='STANDARD'?parsed.allowance:0;
    const taper=Math.max(0,Math.floor((Math.max(ani,0)-100000)/2));
    const pa=parsed.mode==='STANDARD'?Math.max(0,pa0-taper):0;
    if(parsed.mode==='NT') return 0;
    if(parsed.mode==='BR') return mTax*.20;
    if(parsed.mode==='D0') return mTax*.40;
    if(parsed.mode==='D1') return mTax*.45;
    let remaining=Math.max(0,mTax - pa/12), tax=0, lowerA=0;
    const bands=tcfg.bands.ENG_NI;
    for(const b of bands){
      const upperA=(b.upper==null?Infinity:b.upper), sizeM=(upperA-lowerA)/12;
      const take=Math.max(0,Math.min(remaining,sizeM));
      tax+=take*b.rate; remaining-=take; lowerA=upperA; if(remaining<=0) break;
    }
    if(remaining>0) tax+=remaining*bands[bands.length-1].rate;
    return tax;
  }
  function calcNI(mGross,ncfg,overSPA){
    if(overSPA) return 0; const {PT,UEL}=ncfg.monthly;
    if(mGross<=PT) return 0;
    const between=Math.max(0,Math.min(mGross,UEL)-PT);
    const above=Math.max(0,mGross-UEL);
    return between*ncfg.employeeRates.main + above*ncfg.employeeRates.upper;
  }

  const state={ items:[], rates:loadRates(), year:null }; state.year=state.rates.years[0];

  /* DOM refs */
  const elItems=document.getElementById('items'), elAdd=document.getElementById('addItem'), elClear=document.getElementById('clearItems');
  const elDob=document.getElementById('dob'), elTax=document.getElementById('taxCode');
  const elStayPayments=document.getElementById('stayPayments'), elOutPayments=document.getElementById('outPayments');
  const elBenefitEmployer=document.getElementById('benefitEmployer');

  const btnAdmin=document.getElementById('btnAdmin'), adminSec=document.getElementById('admin');
  const btnImport=document.getElementById('importRates'), btnExport=document.getElementById('exportRates');
  const ratesCurrent=document.getElementById('ratesCurrent'), ratesPaste=document.getElementById('ratesPaste');

  const themeSelect=document.getElementById('themeSelect');
  const btnPrintIllo80=document.getElementById('btnPrintIllo80');

  /* Admin visibility via ?admin=1 */
  const isAdmin=new URLSearchParams(location.search).get('admin')==='1';
  if(!isAdmin){ btnAdmin.classList.add('hide'); adminSec.classList.add('hide'); }

  /* Theme control */
  function applyTheme(v){
    document.documentElement.classList.remove('theme-light','theme-dark','theme-hc','theme-hc-large');
    if(v==='light') document.documentElement.classList.add('theme-light');
    else if(v==='dark') document.documentElement.classList.add('theme-dark');
    else if(v==='hc') document.documentElement.classList.add('theme-hc');
    else if(v==='hc-large') document.documentElement.classList.add('theme-hc-large');
  }
  (function initTheme(){ const saved=localStorage.getItem(THEME_KEY)||'auto'; themeSelect.value=saved; applyTheme(saved); })();
  themeSelect.addEventListener('change',()=>{ const v=themeSelect.value; localStorage.setItem(THEME_KEY,v); applyTheme(v); });

  /* Items UI */
  let idSeq=0;
  function itemRow(it){
    const row=document.createElement('div'); row.className='row'; row.dataset.id=it.id;
    const name=document.createElement('input'); name.className='cs4'; name.value=it.label; name.addEventListener('input',()=>{it.label=name.value; render();});
    const wrap=document.createElement('div'); wrap.className='cs3'; wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='8px';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=!!it.useRate; const lbl=document.createElement('span'); lbl.className='small'; lbl.textContent='rate × hours'; wrap.append(chk,lbl);
    const rate=document.createElement('input'); rate.type='number'; rate.placeholder='rate'; rate.className='cs2'; rate.step='0.01'; rate.min='0'; rate.value=it.rate ?? '';
    const hours=document.createElement('input'); hours.type='number'; hours.placeholder='hours'; hours.className='cs2'; hours.step='0.01'; hours.min='0'; hours.value=it.hours ?? '';
    const amount=document.createElement('input'); amount.type='number'; amount.className='cs6'; amount.step='0.01'; amount.min='0'; amount.value=it.amount;
    const preview=document.createElement('div'); preview.className='cs1 small'; preview.style.textAlign='right'; preview.style.opacity='.7';
    const remove=document.createElement('button'); remove.className='cs1 btn'; remove.textContent='×'; remove.type='button'; remove.addEventListener('click',()=>{ state.items=state.items.filter(x=>x.id!==it.id); render(); });

    function toggle(){ if(chk.checked){ rate.classList.remove('hide'); hours.classList.remove('hide'); amount.classList.add('hide'); preview.textContent=fmt((it.rate||0)*(it.hours||0)); it.useRate=true; } else { rate.classList.add('hide'); hours.classList.add('hide'); amount.classList.remove('hide'); preview.textContent=''; it.useRate=false; } }
    chk.addEventListener('change',()=>{ toggle(); render(); }); toggle();
    rate.addEventListener('input',()=>{ it.rate=parseFloat(rate.value||'0'); render(); });
    hours.addEventListener('input',()=>{ it.hours=parseFloat(hours.value||'0'); render(); });
    amount.addEventListener('input',()=>{ it.amount=parseFloat(amount.value||'0'); render(); });

    row.append(name,wrap,rate,hours,amount,preview,remove); return row;
  }
  function addItem(label='Basic',amount=0){ const it={id:'it-'+(idSeq++), label, amount, useRate:false, rate:null, hours:null}; state.items.push(it); elItems.appendChild(itemRow(it)); render(); }
  function rebuildItems(){ elItems.innerHTML=''; state.items.forEach(it=>elItems.appendChild(itemRow(it))); }
  document.getElementById('addItem').addEventListener('click',()=>addItem('Other',0));
  document.getElementById('clearItems').addEventListener('click',()=>{ state.items=[]; rebuildItems(); render(); });
  addItem('Basic',0); addItem('HCA',0);

  /* Admin */
  function refreshAdminText(){ if(ratesCurrent) ratesCurrent.value=JSON.stringify(state.rates,null,2); }
  document.getElementById('btnAdmin')?.addEventListener('click',()=>{ adminSec.classList.toggle('hide'); const ex=document.getElementById('btnAdmin').getAttribute('aria-expanded')==='true'; document.getElementById('btnAdmin').setAttribute('aria-expanded',String(!ex)); refreshAdminText(); });
  btnImport?.addEventListener('click',()=>{ try{ const p=JSON.parse(ratesPaste.value); if(!p?.years?.length) throw new Error('Malformed JSON'); state.rates=p; state.year=p.years[0]; saveRates(p); ratesPaste.value=''; refreshAdminText(); render(); alert('Rates imported.'); }catch(e){ alert('Import failed: '+e.message); }});
  btnExport?.addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(state.rates,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='las-optout-rates.json'; a.click(); URL.revokeObjectURL(url); });

  /* PRINT: Illustration-only (80%) with mobile-safe timing */
  function enableIllustrationPrintFlags(){
    document.documentElement.classList.add('print-illustration','print-compact');
  }
  function disableIllustrationPrintFlags(){
    document.documentElement.classList.remove('print-illustration','print-compact');
  }

  // Some mobile browsers fire print before reflow. Ensure class is active during print.
  const mql = window.matchMedia ? window.matchMedia('print') : null;
  if(mql && mql.addEventListener){
    mql.addEventListener('change', e => { if(e.matches){ enableIllustrationPrintFlags(); } else { disableIllustrationPrintFlags(); }});
  } else if(mql && mql.addListener){ // Safari/iOS fallback
    mql.addListener(e => { if(e.matches){ enableIllustrationPrintFlags(); } else { disableIllustrationPrintFlags(); }});
  }
  window.addEventListener('beforeprint', enableIllustrationPrintFlags);
  window.addEventListener('afterprint', disableIllustrationPrintFlags);

  btnPrintIllo80.addEventListener('click', ()=>{
    // Ensure flags are set, then give the browser a tick to reflow before opening the dialog
    enableIllustrationPrintFlags();
    setTimeout(()=>{ window.print(); }, 50);
    // Safety cleanup in case afterprint doesn't fire
    setTimeout(disableIllustrationPrintFlags, 2000);
  });

  /* Recalc & render */
  function render(){
    const monthlyGross=state.items.reduce((s,it)=> s + (it.useRate?(it.rate||0)*(it.hours||0):(+it.amount||0)),0);
    document.getElementById('totalPay').textContent=fmt(monthlyGross);
    const annualGross=monthlyGross*12, nhsRate=nhsRateFor(annualGross,state.year.nhs);
    document.getElementById('nhsRate').textContent='('+pct(nhsRate)+')';
    const monthlyNhs=(annualGross*nhsRate)/12;

    const monthEnd=new Date(); monthEnd.setMonth(monthEnd.getMonth()+1,0);
    const overSPA=(ageOnDate(elDob.value,monthEnd)??0)>=66;

    const parsed=parseTaxCode(elTax.value);
    const aniStay=Math.max(0,annualGross-annualGross*nhsRate);
    const taxableStay=Math.max(0,monthlyGross-monthlyNhs);

    const taxStay=calcPAYE(taxableStay,aniStay,state.year.tax,parsed);
    const taxOut =calcPAYE(monthlyGross,annualGross,state.year.tax,parsed);
    const niStay=calcNI(monthlyGross,state.year.ni,overSPA);
    const niOut =calcNI(monthlyGross,state.year.ni,overSPA);

    const netStay=monthlyGross-monthlyNhs-taxStay-niStay;
    const netOut =monthlyGross-taxOut-niOut;
    const delta  =netOut-netStay;

    function fill(container){
      container.innerHTML='';
      state.items.forEach(it=>{
        const v=it.useRate?(it.rate||0)*(it.hours||0):(+it.amount||0);
        if(!v) return; const row=document.createElement('div'); row.className='space'; row.innerHTML=`<div>${it.label}</div><div>${fmt(v)}</div>`; container.appendChild(row);
      });
    }
    fill(elStayPayments); fill(elOutPayments);

    document.getElementById('stayTotalPayments').textContent=fmt(monthlyGross);
    document.getElementById('outTotalPayments').textContent =fmt(monthlyGross);
    document.getElementById('stayNhs').textContent=fmt(monthlyNhs);
    document.getElementById('stayTax').textContent=fmt(taxStay);
    document.getElementById('stayNi').textContent =fmt(niStay);
    document.getElementById('stayTotalDeds').textContent=fmt(monthlyNhs+taxStay+niStay);
    document.getElementById('stayNet').textContent=fmt(netStay);
    document.getElementById('stayTaxable').textContent=fmt(taxableStay);

    document.getElementById('outTax').textContent=fmt(taxOut);
    document.getElementById('outNi').textContent =fmt(niOut);
    document.getElementById('outTotalDeds').textContent=fmt(taxOut+niOut);
    document.getElementById('outNet').textContent=fmt(netOut);
    document.getElementById('outTaxable').textContent=fmt(monthlyGross);

    const elDelta=document.getElementById('delta'); elDelta.textContent=fmt(delta); elDelta.className='text-'+(delta>=0?'green':'red');
    document.getElementById('netAnnual').textContent=fmt(netStay*12)+' / '+fmt(netOut*12);

    const employerAnnual=annualGross*(state.year.nhs.employerRateHint||0);
    document.getElementById('employerPension').textContent='≈ '+fmt(employerAnnual)+'/yr';
    elBenefitEmployer.textContent='Employer pension contribution (approx.): '+fmt(employerAnnual)+'/yr';

    refreshAdminText();
  }
  elDob.addEventListener('input',render); elTax.addEventListener('input',render);
  render();
  </script>
</body>
</html>
