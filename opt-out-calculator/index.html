<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NHS Pension Opt-Out Calculator (England only)</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23023020'/><text x='50' y='62' font-family='Arial' font-size='60' text-anchor='middle' fill='white'>£</text></svg>">

  <style>
    /* ---------- LAS-inspired, contrast-safe styles (no external CSS) ---------- */
    :root{
      --brand:#023020; --text:#111; --muted:#4A5568; --bg:#FAFAFA; --panel:#fff; --border:#D6D9DC; --focus:#0B69A3;
      --thead-bg:#F2F5F3; --thead-text:#0B3A2D; --row-active-bg:#E8F4F0; --row-active-text:#111;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0f1214; --panel:#121618; --text:#EDEFF1; --muted:#C7CFD6; --border:#2C343A; --thead-bg:#1A2420; --thead-text:#D6EFE6; --row-active-bg:#0F2F26; --row-active-text:#EDEFF1; }
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0 }
    body{ font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); line-height:1.5; }
    .wrap{ max-width:980px; margin:0 auto; padding:20px; }
    .header{ background:var(--brand); color:#fff; padding:22px 20px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; gap:16px; }
    .header h1{ margin:0 0 4px 0; font-size:22px }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px; margin-top:16px; }
    .grid2{ display:grid; grid-template-columns:1fr; gap:14px } @media(min-width:860px){ .grid2{ grid-template-columns:1fr 1fr } }
    .row{ display:grid; grid-template-columns:repeat(12,1fr); gap:8px; align-items:end }
    .cs1{grid-column:span 1}.cs2{span:2}.cs3{grid-column:span 3}.cs4{grid-column:span 4}.cs6{grid-column:span 6}.cs7{grid-column:span 7}.cs8{grid-column:span 8}.cs12{grid-column:span 12}
    label>span.small{ display:block; font-size:12px; opacity:.85; margin-bottom:4px }
    input,select,textarea{ width:100%; border:1px solid var(--border); background:var(--panel); color:var(--text); border-radius:8px; padding:8px 10px }
    input:focus,select:focus,textarea:focus{ outline:3px solid var(--focus); outline-offset:2px }
    .btn{ appearance:none; background:var(--panel); color:var(--brand); border:2px solid var(--brand); padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer }
    .btn:hover{ background:#F0F7F4 }
    .btn.primary{ background:var(--brand); color:#fff }
    .small{ font-size:12px } .muted{ color:var(--muted) }
    .space{ display:flex; justify-content:space-between; align-items:center }
    .payslip{ display:grid; grid-template-columns:1fr; gap:12px } @media(min-width:860px){ .payslip{ grid-template-columns:1fr 1fr } }
    .card{ border:1px solid var(--border); border-radius:12px; padding:12px }
    .tot{ border-top:1px solid var(--border); padding-top:8px; margin-top:8px; font-weight:700 }
    .kpi{ border:1px solid var(--border); border-radius:12px; padding:12px }
    .note{ border:2px solid var(--border); border-left:6px solid var(--brand); border-radius:10px; padding:10px 12px; background:var(--panel); color:var(--text); }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
    .text-green{ color:#1b8555 } .text-red{ color:#9F3131 }
    .hide{ display:none }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div>
        <h1>NHS Pension Opt-Out Calculator (England only)</h1>
        <p class="small" style="margin:0">Monthly payslip illustration — <b>stay in</b> vs <b>opt out</b>. NI is inferred from your <b>DOB</b> (Cat A by default; Cat C at/over SPA (66); Cat M under 21 uses same employee rates as A).</p>
      </div>
      <div class="actions">
        <button id="btnAdmin" class="btn">Admin</button>
      </div>
    </header>

    <!-- Inputs -->
    <section class="panel grid2" aria-label="Inputs">
      <div>
        <h2 style="margin-top:0">Pensionable pay (monthly)</h2>
        <div id="items"></div>
        <div class="actions" style="margin-top:8px">
          <button id="addItem" class="btn">+ Add item</button>
          <button id="clearItems" class="btn">Clear</button>
        </div>
        <div class="space" style="border-top:1px solid var(--border); padding-top:10px; margin-top:10px">
          <div class="muted">Total monthly pensionable pay</div>
          <div id="totalPay" style="font-weight:800">£0.00</div>
        </div>
      </div>

      <div>
        <h2 style="margin-top:0">Your details</h2>
        <div class="row">
          <label class="cs6"><span class="small">Date of birth</span>
            <input id="dob" type="date" />
          </label>
          <label class="cs6"><span class="small">Tax code (optional)</span>
            <input id="taxCode" type="text" placeholder="1257L, BR, D0, D1, NT" value="1257L"/>
          </label>
        </div>
        <p class="small muted" style="margin-top:8px">We assume the standard NHS “net pay arrangement”.</p>
      </div>
    </section>

    <!-- Payslip -->
    <section class="panel" aria-label="Payslip illustration">
      <h2 style="margin-top:0">Payslip illustration (monthly)</h2>
      <div class="note small" style="margin-bottom:10px">
        <ul style="margin:0 0 0 16px">
          <li><b>Payments</b> lists each pensionable item (Basic, HCA, etc.) you entered.</li>
          <li><b>Deductions</b> lists NHS Pension, PAYE and NI. The PAYE line shows a note with the taxable pay used.</li>
        </ul>
      </div>

      <div class="payslip">
        <!-- Stay in -->
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px">Stay in</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Payments</div>
              <div id="stayPayments"></div>
              <div class="space tot"><div>Total payments</div><div id="stayTotalPayments">£0.00</div></div>
            </div>
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Deductions</div>
              <div class="space"><div>NHS Pension <span id="nhsRate">(0.0%)</span></div><div id="stayNhs">£0.00</div></div>
              <div class="space"><div>PAYE <span class="small muted">(Taxable pay used: <span id="stayTaxable">£0.00</span>)</span></div><div id="stayTax">£0.00</div></div>
              <div class="space"><div>National Insurance</div><div id="stayNi">£0.00</div></div>
              <div class="space tot"><div>Total deductions</div><div id="stayTotalDeds">£0.00</div></div>
            </div>
          </div>
          <div class="space" style="margin-top:10px; font-weight:800"><div>Net pay</div><div id="stayNet">£0.00</div></div>
        </div>

        <!-- Opt out -->
        <div class="card">
          <div style="font-weight:800; margin-bottom:6px">Opt out</div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Payments</div>
              <div id="outPayments"></div>
              <div class="space tot"><div>Total payments</div><div id="outTotalPayments">£0.00</div></div>
            </div>
            <div>
              <div class="muted" style="font-weight:700; margin-bottom:4px">Deductions</div>
              <div class="space"><div>NHS Pension</div><div>£0.00</div></div>
              <div class="space"><div>PAYE <span class="small muted">(Taxable pay used: <span id="outTaxable">£0.00</span>)</span></div><div id="outTax">£0.00</div></div>
              <div class="space"><div>National Insurance</div><div id="outNi">£0.00</div></div>
              <div class="space tot"><div>Total deductions</div><div id="outTotalDeds">£0.00</div></div>
            </div>
          </div>
          <div class="space" style="margin-top:10px; font-weight:800"><div>Net pay</div><div id="outNet">£0.00</div></div>
        </div>
      </div>

      <!-- KPIs -->
      <div style="display:grid; gap:12px; grid-template-columns:1fr; margin-top:12px">
        <div class="kpi">
          <div class="small muted">Difference in take-home (opt-out minus stay-in)</div>
          <div id="delta" style="font-size:20px; font-weight:800">£0.00</div>
        </div>
        <div class="kpi">
          <div class="small muted">Net annual pay — stay in / opt out</div>
          <div id="netAnnual" style="font-size:18px; font-weight:800">£0.00 / £0.00</div>
        </div>
        <div class="kpi">
          <div class="small muted">Employer pension (context)</div>
          <div id="employerPension" style="font-size:18px; font-weight:800">≈ £0.00/yr</div>
          <div class="small muted">Not deducted from pay but foregone if you opt out.</div>
        </div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="panel hide" aria-label="Admin">
      <h2 style="margin-top:0">Admin — Rates (paste/edit yearly)</h2>
      <p class="small muted">Edits save to this browser (localStorage). Export and commit to your repo when ready.</p>
      <div class="grid2">
        <div>
          <label class="small">Current JSON</label>
          <textarea id="ratesCurrent" rows="16" readonly style="width:100%; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; border:1px solid var(--border); border-radius:8px; padding:8px"></textarea>
          <div class="actions" style="margin-top:8px">
            <button id="exportRates" class="btn">Export</button>
          </div>
        </div>
        <div>
          <label class="small">Paste new JSON</label>
          <textarea id="ratesPaste" rows="16" placeholder='{ "years":[ ... ], "defaultYear":"2025/26" }' style="width:100%; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; border:1px solid var(--border); border-radius:8px; padding:8px"></textarea>
          <div class="actions" style="margin-top:8px">
            <button id="importRates" class="btn">Import</button>
          </div>
        </div>
      </div>
    </section>

    <footer class="small muted" style="margin:12px 0 24px">
      HMRC PAYE & NI 2025/26; NHSBSA member tiers 2025/26. For guidance only.
    </footer>
  </div>

  <script>
  // ---------- Data (England & NI only) ----------
  const defaultRates = {
    defaultYear: "2025/26",
    years: [{
      label: "2025/26",
      tax: {
        personalAllowance: 12570,
        higherRateThreshold: 37700,
        additionalRateThreshold: 125140,
        bands: {
          ENG_NI: [
            { upper: 37700, rate: 0.20 },
            { upper: 125140, rate: 0.40 },
            { upper: null, rate: 0.45 }
          ]
        }
      },
      ni: {
        monthly: { LEL: 542, PT: 1048, UEL: 4189 },
        employeeRates: { main: 0.08, upper: 0.02 }
      },
      nhs: {
        tiers: [
          { min: 0, max: 13259, rate: 0.052 },
          { min: 13260, max: 27797, rate: 0.065 },
          { min: 27798, max: 33868, rate: 0.083 },
          { min: 33869, max: 50845, rate: 0.098 },
          { min: 50846, max: 65190, rate: 0.107 },
          { min: 65191, max: null,  rate: 0.125 }
        ],
        employerRateHint: 0.237
      }
    }]
  };

  // ---------- Storage helpers ----------
  function loadRates(){
    try { const raw = localStorage.getItem('las_optout_rates_v1'); if(!raw) return defaultRates;
      const parsed = JSON.parse(raw); return parsed?.years?.length ? parsed : defaultRates;
    } catch { return defaultRates; }
  }
  function saveRates(r){ localStorage.setItem('las_optout_rates_v1', JSON.stringify(r, null, 2)); }

  // ---------- Formatting ----------
  const GBP = new Intl.NumberFormat('en-GB',{style:'currency', currency:'GBP'});
  const fmt = n => GBP.format((+n)||0);
  const pct = n => `${(n*100).toFixed(1)}%`;

  // ---------- Tax helpers ----------
  function parseTaxCode(code){
    const c = (code||'').toUpperCase().trim();
    if(!c) return {mode:'STANDARD', allowance:12570};
    if(['BR','D0','D1','NT'].includes(c)) return {mode:c};
    const m = c.match(/(\\d{3,4})[A-Z]*/);
    if(m) return {mode:'STANDARD', allowance: parseInt(m[1],10)*10};
    return {mode:'STANDARD', allowance:12570};
  }
  function ageOnDate(dob, on){
    if(!dob) return null;
    const b = new Date(dob); if(isNaN(b)) return null;
    let a = on.getFullYear()-b.getFullYear(); const m = on.getMonth()-b.getMonth();
    if(m<0 || (m===0 && on.getDate()<b.getDate())) a--; return a;
  }
  function nhsRateFor(annualPay, nhs){
    const t = nhs.tiers.find(x => annualPay >= x.min && (x.max===null || annualPay <= x.max));
    return t ? t.rate : 0;
  }
  function calcPAYE(monthlyTaxable, annualAdjustedNet, tcfg, parsedCode){
    // Taper: reduce £1 per £2 ANI over £100k
    const pa0 = parsedCode.mode==='STANDARD' ? parsedCode.allowance : 0;
    const taper = Math.max(0, Math.floor((Math.max(annualAdjustedNet,0) - 100000)/2));
    const pa = parsedCode.mode==='STANDARD' ? Math.max(0, pa0 - taper) : 0;
    if(parsedCode.mode==='NT') return 0;
    if(parsedCode.mode==='BR') return monthlyTaxable * 0.20;
    if(parsedCode.mode==='D0') return monthlyTaxable * 0.40;
    if(parsedCode.mode==='D1') return monthlyTaxable * 0.45;

    let remaining = Math.max(0, monthlyTaxable - pa/12);
    let tax = 0, lowerA = 0;
    const bands = tcfg.bands.ENG_NI;
    for(const b of bands){
      const upperA = (b.upper==null?Infinity:b.upper);
      const sizeM = (upperA - lowerA)/12;
      const take = Math.max(0, Math.min(remaining, sizeM));
      tax += take * b.rate;
      remaining -= take;
      lowerA = upperA;
      if(remaining<=0) break;
    }
    if(remaining>0) tax += remaining * bands[bands.length-1].rate;
    return tax;
  }
  function calcNI(monthlyGross, ncfg, overSPA){
    if(overSPA) return 0;
    const {PT, UEL} = ncfg.monthly;
    if(monthlyGross <= PT) return 0;
    const between = Math.max(0, Math.min(monthlyGross, UEL)-PT);
    const above = Math.max(0, monthlyGross - UEL);
    return between*ncfg.employeeRates.main + above*ncfg.employeeRates.upper;
  }

  // ---------- UI state ----------
  const state = {
    items: [],
    rates: loadRates(),
    year: null
  };
  state.year = state.rates.years[0];

  // ---------- DOM ----------
  const elItems = document.getElementById('items');
  const elAdd = document.getElementById('addItem');
  const elClear = document.getElementById('clearItems');
  const elTotalPay = document.getElementById('totalPay');
  const elDob = document.getElementById('dob');
  const elTaxCode = document.getElementById('taxCode');

  const elStayPayments = document.getElementById('stayPayments');
  const elOutPayments = document.getElementById('outPayments');
  const elStayTP = document.getElementById('stayTotalPayments');
  const elOutTP = document.getElementById('outTotalPayments');

  const elNhsRate = document.getElementById('nhsRate');
  const elStayNhs = document.getElementById('stayNhs');
  const elStayTax = document.getElementById('stayTax');
  const elStayNi  = document.getElementById('stayNi');
  const elStayTD  = document.getElementById('stayTotalDeds');
  const elStayNet = document.getElementById('stayNet');
  const elStayTaxable = document.getElementById('stayTaxable');

  const elOutTax   = document.getElementById('outTax');
  const elOutNi    = document.getElementById('outNi');
  const elOutTD    = document.getElementById('outTotalDeds');
  const elOutNet   = document.getElementById('outNet');
  const elOutTaxable = document.getElementById('outTaxable');

  const elDelta = document.getElementById('delta');
  const elNetAnnual = document.getElementById('netAnnual');
  const elEmployer = document.getElementById('employerPension');

  // Admin
  const btnAdmin = document.getElementById('btnAdmin');
  const adminSec = document.getElementById('admin');
  const ratesCurrent = document.getElementById('ratesCurrent');
  const ratesPaste = document.getElementById('ratesPaste');
  const btnImport = document.getElementById('importRates');
  const btnExport = document.getElementById('exportRates');

  // ---------- Items UI ----------
  let idSeq = 0;
  function itemRow(it){
    const row = document.createElement('div');
    row.className = 'row';
    row.dataset.id = it.id;

    const name = document.createElement('input');
    name.className = 'cs4'; name.value = it.label;
    name.addEventListener('input', ()=>{ it.label=name.value; render(); });

    const chkWrap = document.createElement('div');
    chkWrap.className = 'cs3'; chkWrap.style.display='flex'; chkWrap.style.alignItems='center'; chkWrap.style.gap='8px';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.checked=!!it.useRate;
    const chkLbl = document.createElement('span'); chkLbl.className='small'; chkLbl.textContent='rate × hours';
    chkWrap.append(chk, chkLbl);

    const rate = document.createElement('input'); rate.type='number'; rate.placeholder='rate'; rate.className='cs2';
    rate.value = it.rate ?? ''; rate.addEventListener('input', ()=>{ it.rate=parseFloat(rate.value||'0'); render(); });

    const hours = document.createElement('input'); hours.type='number'; hours.placeholder='hours'; hours.className='cs2';
    hours.value = it.hours ?? ''; hours.addEventListener('input', ()=>{ it.hours=parseFloat(hours.value||'0'); render(); });

    const amount = document.createElement('input'); amount.type='number'; amount.className='cs6'; amount.value = it.amount;
    amount.addEventListener('input', ()=>{ it.amount=parseFloat(amount.value||'0'); render(); });

    const preview = document.createElement('div'); preview.className='cs1 small'; preview.style.textAlign='right'; preview.style.opacity='.7';
    const remove = document.createElement('button'); remove.className='cs1 btn'; remove.textContent='×'; remove.title='Remove';
    remove.addEventListener('click', ()=>{ state.items = state.items.filter(x=>x.id!==it.id); render(); });

    function toggleMode(){
      if(chk.checked){ // use rate
        rate.classList.remove('hide'); hours.classList.remove('hide'); amount.classList.add('hide'); preview.textContent = fmt((it.rate||0)*(it.hours||0));
        it.useRate = true;
      }else{
        rate.classList.add('hide'); hours.classList.add('hide'); amount.classList.remove('hide'); preview.textContent = '';
        it.useRate = false;
      }
    }
    chk.addEventListener('change', ()=>{ toggleMode(); render(); });
    toggleMode();

    row.append(name, chkWrap, rate, hours, amount, preview, remove);
    return row;
  }

  function addItem(label='Basic', amount=0){
    const it = { id: 'it-' + (idSeq++), label, amount, useRate:false, rate:null, hours:null };
    state.items.push(it);
    elItems.appendChild(itemRow(it));
    render();
  }

  function rebuildItems(){
    elItems.innerHTML = '';
    state.items.forEach(it => elItems.appendChild(itemRow(it)));
  }

  elAdd.addEventListener('click', ()=> addItem('Other', 0));
  elClear.addEventListener('click', ()=> { state.items=[]; rebuildItems(); render(); });

  // Initial two rows like your sheet
  addItem('Basic', 0);
  addItem('HCA', 0);

  // ---------- Admin ----------
  function refreshAdminText(){ ratesCurrent.value = JSON.stringify(state.rates, null, 2); }
  btnAdmin.addEventListener('click', ()=>{ adminSec.classList.toggle('hide'); refreshAdminText(); });
  btnImport.addEventListener('click', ()=>{
    try{
      const parsed = JSON.parse(ratesPaste.value);
      if(!parsed?.years?.length) throw new Error('Malformed JSON');
      state.rates = parsed; state.year = parsed.years[0]; saveRates(parsed);
      ratesPaste.value = ''; refreshAdminText(); render();
      alert('Rates imported.');
    }catch(e){ alert('Import failed: ' + e.message); }
  });
  btnExport.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state.rates,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download='las-optout-rates.json'; a.click(); URL.revokeObjectURL(url);
  });

  // ---------- Recalc & render ----------
  function render(){
    // totals
    const monthlyGross = state.items.reduce((s,it)=> s + (it.useRate ? (it.rate||0)*(it.hours||0) : (+it.amount||0)), 0);
    elTotalPay.textContent = fmt(monthlyGross);

    // annual
    const annualGross = monthlyGross * 12;
    const nhsRate = nhsRateFor(annualGross, state.year.nhs);
    elNhsRate.textContent = '(' + pct(nhsRate) + ')';

    const monthlyNhs = (annualGross * nhsRate) / 12;

    // NI category: over SPA at month end => C (EE NI £0). Under 21 => M (same EE rate as A).
    const monthEnd = new Date(); monthEnd.setMonth(monthEnd.getMonth()+1, 0);
    const age = ageOnDate(elDob.value, monthEnd);
    const overSPA = age!==null ? age>=66 : false;

    // PAYE
    const parsedCode = parseTaxCode(elTaxCode.value);
    const aniStay = Math.max(0, annualGross - annualGross*nhsRate);
    const taxableStay = Math.max(0, monthlyGross - monthlyNhs);

    const taxStay = calcPAYE(taxableStay, aniStay, state.year.tax, parsedCode);
    const taxOut  = calcPAYE(monthlyGross, annualGross, state.year.tax, parsedCode);

    // NI
    const niStay = calcNI(monthlyGross, state.year.ni, overSPA);
    const niOut  = calcNI(monthlyGross, state.year.ni, overSPA);

    // Net
    const netStay = monthlyGross - monthlyNhs - taxStay - niStay;
    const netOut  = monthlyGross - taxOut - niOut;
    const delta   = netOut - netStay;

    // Payments lists (hide £0 rows)
    function fillPayments(container){
      container.innerHTML='';
      state.items.forEach(it=>{
        const val = it.useRate ? (it.rate||0)*(it.hours||0) : (+it.amount||0);
        if(!val) return;
        const row=document.createElement('div'); row.className='space';
        row.innerHTML=`<div>${it.label}</div><div>${fmt(val)}</div>`;
        container.appendChild(row);
      });
    }
    fillPayments(elStayPayments); fillPayments(elOutPayments);

    // Fill deductions & totals
    elStayTP.textContent = fmt(monthlyGross);
    elOutTP.textContent  = fmt(monthlyGross);

    elStayNhs.textContent = fmt(monthlyNhs);
    elStayTax.textContent = fmt(taxStay);
    elStayNi.textContent  = fmt(niStay);
    elStayTD.textContent  = fmt(monthlyNhs + taxStay + niStay);
    elStayNet.textContent = fmt(netStay);
    elStayTaxable.textContent = fmt(taxableStay);

    elOutTax.textContent   = fmt(taxOut);
    elOutNi.textContent    = fmt(niOut);
    elOutTD.textContent    = fmt(taxOut + niOut);
    elOutNet.textContent   = fmt(netOut);
    elOutTaxable.textContent = fmt(monthlyGross);

    // KPIs
    elDelta.textContent = fmt(delta);
    elDelta.className = 'text-'+(delta>=0?'green':'red');
    elNetAnnual.textContent = fmt(netStay*12) + ' / ' + fmt(netOut*12);
    elEmployer.textContent  = '≈ ' + fmt(annualGross * (state.year.nhs.employerRateHint||0)) + '/yr';

    // Admin JSON (keep fresh)
    refreshAdminText();
  }

  elDob.addEventListener('input', render);
  elTaxCode.addEventListener('input', render);

  // initial
  render();
  </script>
</body>
</html>
